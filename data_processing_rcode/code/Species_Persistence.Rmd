---
title: 'Species Persistence: Data Processing and Visualization'
author: "NOAA Fisheries' Office of Science and Technology"
date: "2025-06-05"
output:
  html_document:
    toc: yes
    toc_float: true
    theme: readable
    code_folding: hide
  word_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)

library(here)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(readr)
library(tidyverse)
```


*Code chunks can be viewed by pressing the `SHOW` button on the right hand side of the document*

## Background

This document presents various analyses for evaluating species persistence as a new analysis module on [DisMAP](https://apps-st.fisheries.noaa.gov/dismap/). 

**The Species Persistence module is in a pilot period. Feedback is encouraged and can always be given by submitting a pull request through GitHub, taking our [feedback survey](https://docs.google.com/forms/d/1yJX11wHzLBh1mQEKEKV_JcsNimdiAC75qtmqTsUw_ZE/viewform?pli=1&pli=1&edit_requested=true), or emailing us at.. [dismap.contact@noaa.gov](dismap.contact@noaa.gov).**


The goals for this analysis are four-fold:

* Visualize changes in observed biomass for a particular species, from year to year
* Categorize survey abundance as being: 
  + absent, 
  + rare, 
  + less common,
  + common,
  + abundant,
  + or highly abundant
* Measure overall prevalence pattern of a particular species, across all survey years
* Categorize trend as:
  + Persistently Present, 
  + Emerged,
  + Potentially Emerging,
  + Potentially Disappearing,
  + Disappeared,
  + Sporadic - Primarily Present,
  + or Sporadic - Primarily Absent



```{r wrangling, message = FALSE}
# data <- data.frame(base::readRDS(file = here::here("data_processing_rcode/output/data_clean/alldata_withzeros.rds")))

## building a dataset for last year. Normally, data would be pulled in from the RDS and titled `data`, as shown at the top of this code chunk ##

bfish <- read_csv(here::here("data_processing_rcode/data", "BFISH_DisMAP_2024_update_v2.csv")) 

ai <- read_csv(here::here("data_processing_rcode","output","python", "AI_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
ebs <- read_csv(here::here("data_processing_rcode","output","python", "EBS_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
gmex <- read_csv(here::here("data_processing_rcode","output","python", "GMEX_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
goa <- read_csv(here::here("data_processing_rcode","output","python", "GOA_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
nbs <- read_csv(here::here("data_processing_rcode","output","python", "NBS_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
neus_fall <- read_csv(here::here("data_processing_rcode","output","python", "NEUS_FAL_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
neus_spri <- read_csv(here::here("data_processing_rcode","output","python", "NEUS_SPR_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
seus_fall <- read_csv(here::here("data_processing_rcode","output","python", "SEUS_FAL_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
seus_spri <- read_csv(here::here("data_processing_rcode","output","python", "SEUS_SPR_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
seus_sum <- read_csv(here::here("data_processing_rcode","output","python", "SEUS_SUM_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
wc_ann <- read_csv(here::here("data_processing_rcode","output","python", "WC_ANN_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
wc_tri <- read_csv(here::here("data_processing_rcode","output","python", "WC_TRI_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)

data <- rbind(bfish, ai, ebs, gmex, goa, nbs, neus_fall, neus_spri, seus_fall, seus_spri, seus_sum, wc_ann, wc_tri)
```

## Data Processing

```{r tech report table, eval=FALSE}
#eval default is false because this chunk is only needed for tech report generation
summary <- data %>% 
  group_by(region) %>% 
  summarize(count = n_distinct(spp))

```


### Biomass percentile
This section captures the data by calculating percentile/rank of biomass of a specific species, compared to all the species biomass in that survey region and survey year.

```{r prep}
# need to edit naming for regions versus surveys
data$survey <- ifelse(data$region == "Aleutian Islands", "Aleutian Islands Bottom Trawl Survey",
                         ifelse(data$region == "Eastern Bering Sea", "Eastern Bering Sea Crab/Groundfish Bottom Trawl Survey",
                                ifelse(data$region == "Northern Bering Sea", "Northern Bering Sea Crab/Groundfish Survey - Eastern Bering Sea Shelf Survey Extension",
                                       ifelse(data$region == "Gulf of Alaska", "Gulf of Alaska Bottom Trawl Survey",
                                              ifelse(data$region == "Gulf of Mexico", "Gulf of Mexico Summer Shrimp/Groundfish Survey",
                                                     ifelse(data$region == "Northeast US Fall", "NEFSC Fall Bottom Trawl",
                                                            ifelse(data$region == "Northeast US Spring", "NEFSC Spring Bottom Trawl",
                                                                   ifelse(data$region == "Southeast US Fall", "SEAMAP Fall Coastal Trawl Survey",
                                                                          ifelse(data$region == "Southeast US Spring", "SEAMAP Spring Coastal Trawl Survey",
                                                                                 ifelse(data$region == "Southeast US Summer", "SEAMAP Summer Coastal Trawl Survey",
                                                                                        ifelse(data$region == "West Coast Annual", "West Coast Bottom Trawl Annual",
                                                                                               ifelse(data$region == "West Coast Triennial", "West Coast Bottom Trawl Triennial",
                                                                                                      ifelse(data$region == "Hawaii", "Bottomfish Fishery-Independent Survey in Hawaii (BFISH)",
                                                                                                             ifelse(data$region == "Eastern and Northern Bering Sea", NA, NA))))))))))))))

data_update <- data %>%
  filter(!is.na(survey)) %>%
  mutate(region_old = region) %>%
  select(-region)

data_update$region <- ifelse(data_update$region_old == "Aleutian Islands", "Aleutian Islands",
                             ifelse(data_update$region_old == "Eastern Bering Sea", "Eastern Bering Sea",
                                    ifelse(data_update$region_old == "Northern Bering Sea", "Northern Bering Sea",
                                           ifelse(data_update$region_old == "Gulf of Alaska", "Gulf of Alaska",
                                                  ifelse(data_update$region_old == "Gulf of Mexico", "Gulf of Mexico",
                                                         ifelse(data_update$region_old == "Northeast US Fall", "Northeast US",
                                                                ifelse(data_update$region_old == "Northeast US Spring", "Northeast US",
                                                                       ifelse(data_update$region_old == "Southeast US Fall", "Southeast US",
                                                                              ifelse(data_update$region_old == "Southeast US Spring", "Southeast US",
                                                                                     ifelse(data_update$region_old == "Southeast US Summer", "Southeast US",
                                                                                            ifelse(data_update$region_old == "West Coast Annual", "West Coast",
                                                                                                   ifelse(data_update$region_old == "Hawaii", "Hawai'i Islands",
                                                                                                          ifelse(data_update$region_old == "West Coast Triennial", "West Coast", NA)))))))))))))

```

We calculate total biomass for each species in each year for each survey. Then we remove zero biomass records because these values would skew percentile calculations in the following step. These will be added back in after the percentile calculations.
```{r}
data_sum <- data_update %>%
  select(region, survey, spp, year, common, wtcpue) %>%
  group_by(region, survey, year, spp, common) %>%
  summarise(wtcpue = sum(wtcpue))

data_sum_zeros <- data_sum %>% 
  filter(wtcpue == 0)

data_sum_nozeros <- data_sum %>% 
  filter(wtcpue > 0)
```

Using the `cume_dist()` function here (as opposed to the `percent_rank()` function) to rank biomass values as percentiles because this method will not produce a percentile of zero. Percentiles are calculated for a particular species, in comparison to all the biomass values for all species in a survey/survey region, across all survey years.
```{r percentile, message = FALSE}

data_rank_nozeros <- data_sum_nozeros %>%
  group_by(region, survey) %>%
  mutate(percentile = cume_dist(wtcpue))

```

Then, we bring the zero biomass rows back in after the percentiles are calculated and `rbind` them to the data set with percentiles calculated. Species that have zero biomass in a survey region for a survey year will have a percentile value of zero. Any species that has a survey biomass > 0 for a survey year will have a ranked percentile value, in comparison to all the biomass values in that survey region across all survey years.
```{r}

data_rank <- rbind(data_rank_nozeros, data_sum_zeros) %>% 
  dplyr::rename(Region = region,
                SurveyName = survey,
                Common = common,
                Species = spp,
                Year = year,
                WTCPUE = wtcpue,
                Percentile = percentile) %>% 
  mutate(Percentile = ifelse(is.na(Percentile), 0, Percentile))
  
```

The percentile values are then binned as being "Absent" (biomass and percentile of 0), "Rare" (< 10th percentile), "Less Common" (10th - 25th percentile), "Common" (25th - 75th percentile), "Abundant" (75th - 90th percentile), or "Highly Abundant" (> 90th percentile).
```{r binning}

data_rank$Bin <- ifelse(data_rank$Percentile == 0.0, "Absent",
                        ifelse(data_rank$Percentile > 0.0 & data_rank$Percentile <= 0.10, "Rare",
                               ifelse(data_rank$Percentile > 0.10 & data_rank$Percentile <= 0.25, "Less Common",
                                      ifelse(data_rank$Percentile > 0.25 & data_rank$Percentile <= 0.75, "Common",
                                             ifelse(data_rank$Percentile > 0.75 & data_rank$Percentile <= 0.90, "Abundant",
                                                    ifelse(data_rank$Percentile > 0.90, "Highly Abundant", NA))))))

```

Then, we assign all species with survey biomass > 0 as present in that year's survey and < 0 as being absent in that year's survey.
```{r presence_absence}

data_rank$Absence_Presence <- ifelse(data_rank$WTCPUE == 0, "0",
                                     ifelse(data_rank$WTCPUE > 0, "1", "NA"))

#Absence is 0 and Presence is 1

```


### Presence in hauls
This section will calculate the number of hauls that a species is present in, per survey and per year. Measuring the presence in hauls will capture the prevalence of that species in the survey (i.e., how prominent is this species in the survey?), over time.

```{r functions, message = FALSE}

present_every_year <- function(dat, ...){
  presyr <- dat %>%
    filter(wtcpue > 0) %>%
    group_by(...) %>%
    summarise(pres = n())
  return(presyr)
}

num_hauls_year <- function(dat, ...){
  haulsyr <- dat %>%
    select(c(region, survey, haulid, year)) %>%
    distinct() %>%
    group_by(...) %>%
    summarise(hauls = n())
  return(haulsyr)
}

```

We calculate the number of hauls total (in each survey and survey year) and the number of hauls for which a particular species was caught. We then also calculate the proportion of total hauls each species was caught in (for each survey and survey year).
```{r build data_haul}

presyr <- present_every_year(data_update, region, survey, spp, common, year)

haulsyr <- num_hauls_year(data_update, region, survey, year)

# data frame with the number of hauls a species is present for, 
preshaul <- left_join(presyr, haulsyr, by=c("region", "survey", "year")) %>%
  mutate(proportion=((pres/hauls)*100))

data_haul <- preshaul %>% 
  select(-hauls) %>% 
  dplyr::rename(Region = region,
                Species = spp,
                Common = common,
                SurveyName = survey,
                Year = year,
                Presence = pres,
                Proportion = proportion)

```


### Binding haul count to percentiles

Using left_join to add the `Presence` and `Proportion` values from `data_haul` to the corresponding survey and species in `data_rank`. Any zero biomass/percentile will turn up as `NA` values in the haul presence column when it's joined. We have converted these `NA`'s to zeros because those are instances in which the species was not landed in the survey. **This builds our full data set of results.**

```{r}
data_full <- data_rank %>% 
  left_join(data_haul, by = c("Region", "SurveyName", "Species", "Common", "Year")) %>% 
  mutate(Presence = ifelse(is.na(Presence), 0, Presence)) %>% 
  mutate(Proportion = ifelse(is.na(Proportion), 0, Proportion))

# saveRDS(data_full, file = "data_full.RData")
```


```{r exporting data_full}
# writing the csv for DisMAP development team here
data_export <- data_full %>% 
  select(Region, SurveyName, Year, Species, Common, Bin, WTCPUE)

# write.csv(data_export, here::here("data_processing_rcode","output","data_clean","SpeciesPersistenceIndicatorPercentileBin.csv"))
```


## Vizualizations

```{r}
#load packages needed for visualization section
library(tidyverse)
library(hrbrthemes)
library(viridis)
library(plotly)
library(heatmaply)
```

The goal of this data processing is for users to be able to clearly see trends in the prevalence of species in surveys over time so that they can notice species that might be emerging or disappearing in a region.

**Note: Many of these visualizations are interactive. To see the values depicted in each cell, simply hover your cursor over the plot. To zoom in on a set of species or years, hold and drag your cursor to draw a box around the desired region.**

### All Surveys - Facet Wrapped
This code block needs to be changed to `eval = TRUE` to run/knit. Default is currently `eval = FALSE` because this chunk takes some time to process.
```{r all surveys viz, eval=FALSE, message=FALSE, warning=FALSE}

#### This takes a long time to knit so be prepared! ####

data_all <- data_full %>%
  ungroup()

surveys <- unique(data_all$SurveyName)

plotlist <- list()

for(v in surveys) {
  
  dat <- data_all %>% 
    filter(SurveyName == v)
  
  dat$Bin <- factor(dat$Bin, levels = c('Absent', 'Rare', 'Less Common', 'Common', 'Abundant', 'Highly Abundant'))
  
  p <- ggplot(dat, aes(Year, Common)) +
    geom_tile(aes(fill= Bin)) +
    ggtitle(paste(v)) +
    theme_minimal() +
    scale_fill_viridis(discrete=TRUE, option="viridis")
    # theme(axis.text.y = element_text(size = 8))
  
  # Convert ggplot to ggplotly and display
  plotlist[[v]] <- ggplotly(p)
  
}

htmltools::tagList(setNames(plotlist, NULL))

```


## Trend assessment

**Trend Categories**

- Persistently Present: Consistently observed in surveys across years;
- Established: Species previously wasn't observed in surveys and now is consistently observed in surveys;
- Potentially Emerging: Species previously wasn't consistently observed in surveys but is potentially shifting towards being consistently observed;
- Potentially Disappearing: Species was previously observed in surveys but is potentially shifting towards being consistently not observed;
- Disappeared: Species was previously observed in surveys but now is consistently not observed in surveys;
- Sporadic - Primarily Present: Species is observed in over half of surveys but observations are inconsistent; and
- Sporadic - Primarily Absent: Species is observed in less than half of surveys and observations are inconsistent.

```{r organization}
data_cumm <- data_full %>% 
  select(Region, SurveyName, Year, Species, Common, Absence_Presence)

data_cumm$Absence_Presence <- as.numeric(data_cumm$Absence_Presence)
```

To do this, first we identify instances in which a species shifts from being present in a survey one year to being absent in a survey the following year, and vice versa.
```{r col vs ext}
holding <- data.frame(SurveyName = character(), Species = character(), Year = numeric(), Diff = numeric(), stringsAsFactors = FALSE)


surveys <- unique(data_cumm$SurveyName)

for(v in surveys) {

  firstfilt <- data_cumm %>%
    filter(SurveyName == v)

  spps <- unique(firstfilt$Species)

  for (p in spps) {

    myfilt <- firstfilt %>%
      filter(Species == p)

    years <- c(myfilt$Year)
    years <- years[order(years)]


    for (i in 1:(length(years)-1)) {

      var_1 <- myfilt %>%
        filter(Year == years[i])

      var_2 <- myfilt %>%
        filter(Year == years[i+1])

      Diff <- var_2$Absence_Presence[1] - var_1$Absence_Presence[1]

      temp <- data.frame(SurveyName = v, Species = p, Year = years[i+1], Diff = Diff, stringsAsFactors = FALSE)

      holding <- rbind(holding, temp)

    }
  }
}

```

```{r adding common names}
# Creating a speices list will allow for joining in the common names at the end of the next chunk
spp_list <- distinct(data_full %>% 
  ungroup() %>% 
  select(SurveyName, Species, Common))

```

```{r}
# Identifying when species goes from absent to present in survey
data_ce_col <- holding %>% 
  filter(Diff == 1) %>% 
  group_by(SurveyName, Species) %>% 
  summarise(col = n())

# Identifying when species goes from present to absent in survey
data_ce_ext <- holding %>% 
  filter(Diff == -1) %>% 
  group_by(SurveyName, Species) %>% 
  summarise(ext = n())

# Identifying when species remains as either absent or present in survey
data_ce_stable <- holding %>% 
  filter(Diff == 0) %>% 
  group_by(SurveyName, Species) %>% 
  summarise(stable = n())

# merging three objects above
data_ce <- data_ce_stable %>%
  full_join(data_ce_col, by = c("SurveyName", "Species")) %>% 
  full_join(data_ce_ext, by = c("SurveyName", "Species")) %>% 
  replace(is.na(.), 0) %>% 
  select(-stable) %>% 
  left_join(spp_list, by = c("SurveyName", "Species")) %>% 
  select(SurveyName, Species, Common, col, ext)

# saveRDS(data_ce, file = "data_ce.RData")
```


**Trend Category Metrics**

- *Persistently Present*: Observed in >=85% of survey years
- *Emerged*: Observed in >=50% of years, observed more in the second half of the survey years (compared to the first half of survey years), observed in >= 75% of the second half of survey years, and observed in at least nine (presence >= 9) of the final ten survey years
- *Potentially Emerging*: Observed in <= 50% of years in the first half of survey years and observed in at least four (presence >= 4) of the final five survey years, or has one switch from not being observed to being observed (referred to as a "colonizing event") and has zero switches from being observed to not being observed (referred to as a leaving event)
- *Potentially Disappearing*: Observed in >= 50% of years in the first half of survey years and observed in at most one (presence <= 1) of the final five survey years, or has one switch from being observed to not being observed (leaving event) and has zero switches from not being observed to being observed (colonizing event)
- *Disappeared*: Observed in <=50% of years, observed more in the first half of the survey years (compared to the second half of survey years), observed in <= 25% of the second half of survey years, and observed in at most one (presence <= 1) of the final ten survey years
- *Sporadic - Primarily Present*: Observed in >=50% of years
- *Sporadic - Primarily Absent*: Observed in <50% of years

```{r build data df}
#adding colonzation and extinction event columns to data frame to use in trend categorization
data <- data_full %>% 
  left_join(data_ce, by = c("SurveyName", "Species", "Common"))

```

```{r function add_trend_category}

add_trend_category <- function(data) {
  data %>%
    arrange(Region, SurveyName, Species, Common, Year) %>%
    group_by(Region, SurveyName, Species, Common) %>%
    group_modify(~{
      df <- .x
      n_years <- nrow(df)
      abs_vec <- df$Absence_Presence
      percent_present <- sum(abs_vec == 1, na.rm = TRUE) / n_years

      # Indices for first/last half
      half_n <- floor(n_years / 2)
      first_half_idx <- seq_len(half_n)
      last_half_idx <- seq(n_years - half_n + 1, n_years)

      abs_first_half <- if(length(first_half_idx) > 0) sum(abs_vec[first_half_idx] == 1, na.rm = TRUE) else NA_real_
      abs_last_half <- if(length(last_half_idx) > 0) sum(abs_vec[last_half_idx] == 1, na.rm = TRUE) else NA_real_
      percent_first_half <- if(length(first_half_idx) > 0) abs_first_half / length(first_half_idx) else NA_real_
      percent_last_half <- if(length(last_half_idx) > 0) abs_last_half / length(last_half_idx) else NA_real_

      # Indices for last 5 years
      last5_n <- min(5, n_years)
      last5_idx <- seq(n_years - last5_n + 1, n_years)
      abs_last5 <- if(length(last5_idx) > 0) sum(abs_vec[last5_idx] == 1, na.rm = TRUE) else NA_real_
      
      # Indices for last 10 years
      last10_n <- min(10, n_years)
      last10_idx <- seq(n_years - last10_n + 1, n_years)
      abs_last10 <- if(length(last10_idx) > 0) sum(abs_vec[last10_idx] == 1, na.rm = TRUE) else NA_real_

      trend_category <- case_when(
        percent_present >= 0.85 & abs_last5 >= 4 ~ "Persistently Present",
        percent_present >= 0.5 & abs_last10 >= 9 &
          percent_last_half >= 0.75 &
          abs_first_half <= abs_last_half ~ "Emerged",
        percent_present <= 0.5 & abs_last10 <= 1 &
          percent_last_half <= 0.25 &
          abs_first_half >= abs_last_half ~ "Disappeared",
        abs_last5 >= 4 & percent_first_half <= 0.50 ~ "Potentially Emerging",
        any(df$col == 1 & df$ext == 0, na.rm = TRUE) ~ "Potentially Emerging",
        abs_last5 <= 1 & percent_first_half >= 0.50 ~ "Potentially Disappearing",
        any(df$col == 0 & df$ext == 1, na.rm = TRUE) ~ "Potentially Disappearing",
        percent_present >= 0.5 ~ "Sporadic - Primarily Present",
        percent_present < 0.5 ~ "Sporadic - Primarily Absent",
        TRUE ~ NA_character_
      )
      df$TrendCategory <- trend_category
      df
    }) %>%
    ungroup()
}

# Usage:
data_full_trends <- add_trend_category(data) %>%
  mutate(Name = paste(Common, SurveyName, sep = "_"))

data_summary <- add_trend_category(data) %>%
  select(Region, SurveyName, Species, Common, TrendCategory) %>%
  distinct()
```

```{r species flag function}

data <- data_full_trends

flag_spp <- function(data, survey){
  
  cat("taxonomy check for survey: ", survey, sep="\n")
  
  #select region (survey column)
  data_survey <- data %>% 
    dplyr::mutate(SurveyName = forcats::as_factor(SurveyName)) %>% 
    dplyr::filter(SurveyName == survey)
  
  
  #get grouped species names per year
  df <- data_survey %>%
    dplyr::select(Species, Year, Absence_Presence) %>%
    dplyr::group_by(Species) %>%
    dplyr::distinct()

  
  #make species x year matrix
  years <- unique(df$Year)
  df2 <- data.frame(matrix(ncol = length(years)+1, nrow = length(df$Species)))
  x <- c('spp', unique(df$Year))
  colnames(df2) <- x
  df2$spp <- df$Species
  
  #fill up matrix with FALSE/TRUE depending on species presence/absence
  n <- 2
  for (y in years) {
    df2[, n] <- sapply(df2$spp, function(spp_name) {
      any(df$Species == spp_name & df$Year == y & df$Absence_Presence == 1)
      })
    n <- n + 1
    }
  
  #summarize
  df2 <- df2 %>%
    dplyr::group_by(spp) %>%
    dplyr::summarize_all(any)
  
  #create new dataframe
  df3 <- data.frame(matrix(ncol = 3, nrow = length(df2$spp)))
  colnames(df3) <- c('spp', 'rlmax', 'PresToAbs')
  
  #fill up the dataframe
  for (n in 1:length(df2$spp)){
    
    #Compute the lengths and values of runs of equal values in a vector
    r <- rle(df2[n,])
    
    sp <- c(df2[n,1])
    
    rlmax <- max(r$lengths)
    
    df3[n,1] <- sp
    df3[n,2] <- rlmax #maximum run length
    df3[n,3] <- length(r$values) #total nb of runs
    
  }
  
  #get species with maximum run length lower than 95% of the years (56)
  #and that occurred in less than 4 runs
  x <- round(0.95*length(years))
  df3 <- df3[df3$rlmax < x,]
  df3 <- df3[df3$PresToAbs < 4,]
  
  testdf <- data.frame(spp = df3$spp)
  
  if (dim(testdf)[1] > 0) {
    
    #write txt of flagged spp in region
    # sink(here::here("outputs", "Flags", "taxonomic_flagging", paste0(region, "_flagspp.txt")))
    # cat(testdf$spp, sep = " ; ")
    # sink()
    
    #write stats of species flagged
    # data_out <- data.frame("name" = c("Total number of species", "Percentage of species flagged"),
    #                    "nb" = c(length(df2$spp), round(100*(length(testdf$spp) /  length(df2$spp)), 1)))
    # write.csv(data_out, file = here::here("data_processing_rcode", "output", paste0(survey, "_stats.csv")), row.names = FALSE)
    
    #write df of species flagged
    survey_clean <- gsub("[/\\]", "_", survey)  # Replace slashes/backslashes with underscore
    write.csv(df3, file = here::here("data_processing_rcode", "output", "flags", paste0(survey_clean, "_flags.csv")), row.names = FALSE)
    
    #create absence dataframe for plotting
    allyears <- min(years):max(years)
    abs <- data.frame("accepted_name" = rep(df3$spp, each = length(allyears)),
                      "year" = rep(allyears, length(df3$spp)))
    
    #get presence dataframe for plotting
    pres <- subset(data_survey, Species %in% testdf$spp) %>%
      dplyr::select(Species, Year)

  }else{
    
    print("----- No species flagged for this region")
  }
  
}

```


```{r flag compilation}

survey_list <- unique(data_full_trends$SurveyName)

for (i in survey_list) {
  flag_spp(data, survey = i)
}


#bringing csv files back into combine them into one df
folder_path <- here::here("data_processing_rcode", "output", "flags")

files <- list.files(path = folder_path, pattern = "\\.csv$", full.names = TRUE)
# files_clean <- paste0(list.files(path = folder_path, pattern = "\\.csv$", full.names = FALSE)) 
  
df_list <- list()

for (n in seq_along(files)){
  #read in csv
  temp_df <- read_csv(files[n])
  # Get the file name without path and extension
  name <- tools::file_path_sans_ext(basename(files[n]))
  # Remove the string "flag" at the end, if present
  name <- sub("_flags$", "", name)
  # Add the source column as the first column
  temp_df <- cbind(survey = name, temp_df)
  # Store in list
  df_list[[n]] <- temp_df
}

flags_combo <- do.call(rbind, df_list) %>% 
  rename(SurveyName = survey,
         Species = spp) %>% 
  mutate(SurveyName = gsub("_", "/", SurveyName))

flags_combo$Notes <- c(rep("Preliminary trend - under review", nrow(flags_combo)))

```

```{r trend viz}
#Persistently Present 
trend_pres <- data_full_trends %>% 
  filter(TrendCategory == "Persistently Present")

ggplot(trend_pres, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Persistently Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

#Emerged
trend_estab <- data_full_trends %>% 
  filter(TrendCategory == "Emerged")

p6 <- ggplot(trend_estab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Emerged") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p6)


#Disappeared 
trend_disapp <- data_full_trends %>% 
  filter(TrendCategory == "Disappeared")

p2 <- ggplot(trend_disapp, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Disappeared") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p2)

#Potentially Emerging 
trend_emerging <- data_full_trends %>% 
  filter(TrendCategory == "Potentially Emerging")

p3 <- ggplot(trend_emerging, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Emerging") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p3)

#Potentially Disappearing 
trend_potdis <- data_full_trends %>% 
  filter(TrendCategory == "Potentially Disappearing")

p7 <- ggplot(trend_potdis, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Disappearing") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p7)

#Sporadic - Primarily Present 
trend_spopre <- data_full_trends %>% 
  filter(TrendCategory == "Sporadic - Primarily Present")

p5 <- ggplot(trend_spopre, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p5)


#Sporadic - Primarily Absent 
trend_spoab <- data_full_trends %>% 
  filter(TrendCategory == "Sporadic - Primarily Absent")

p4 <- ggplot(trend_spoab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Absent") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p4)

```



