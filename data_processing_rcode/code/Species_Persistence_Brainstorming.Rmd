---
title: 'Species Persistence: Visualization Options'
author: "Claire Gonzales (2025 Knauss Fellow, NOAA Affiliate)"
date: "2025-05-06"
output:
  html_document:
    toc: yes
    theme: readable
    code_folding: hide
  word_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)

library(here)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(readr)
```


*Code chunks can be viewed by pressing the `SHOW` button on the right hand side of the document*

## Background

This document presents various analyses for evaluating species persistence (emergence, consistence persistence, or removal) as a new analysis module on [DisMAP](https://apps-st.fisheries.noaa.gov/dismap/). 

**Feedback on the usefulness of these analyses and visualizations would be greatly appreciated. Specifically, we would appreciate any comments on which visualization of the data (if any) you feel would be most useful to DisMAP end-users. Please feel free to contact Melissa and Claire at any time with questions or comments.**


The goals for this indicator are four-fold:

* Visualize changes in biomass (or presence/absence) for a particular species, from year to year
* Categorize survey abundance as being: 
  + absent, 
  + rare, 
  + less common,
  + common,
  + abundant
  + or highly abundant
* Measure overall prevalence pattern of a particular species, across all survey years (*in development and not presented here*)
* Categorize trend as (*in development and not presented here*):
  + increasing, 
  + decreasing,
  + or consistent

In this current draft of the analyses, we present data processing steps as well as four draft heat maps. The heat maps reflect

  1. the frequency of tows a particular species is caught in (by year and by survey),
  2. the proportion of tows for a particular species is caught in (by year and by survey),
  3. the percentile of biomass for a particular species (by year and by survey), and
  4. the binned percentile of biomass for a particular species (by year and by survey).

```{r wrangling, message = FALSE}
# data <- data.frame(base::readRDS(file = here::here("data_processing_rcode/output/data_clean/alldata_withzeros.rds")))

## creating an example dataset for last year. Normally, data would be pulled in from the RDS and titled `data`, as shown at the top of this code chunk ##

bfish <- read_csv(here::here("data_processing_rcode/data", "BFISH_DisMAP_2024_update_v2.csv")) 

ai <- read_csv(here::here("data_processing_rcode","output","python", "AI_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
ebs <- read_csv(here::here("data_processing_rcode","output","python", "EBS_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
gmex <- read_csv(here::here("data_processing_rcode","output","python", "GMEX_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
goa <- read_csv(here::here("data_processing_rcode","output","python", "GOA_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
nbs <- read_csv(here::here("data_processing_rcode","output","python", "NBS_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
neus_fall <- read_csv(here::here("data_processing_rcode","output","python", "NEUS_FAL_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
neus_spri <- read_csv(here::here("data_processing_rcode","output","python", "NEUS_SPR_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
seus_fall <- read_csv(here::here("data_processing_rcode","output","python", "SEUS_FAL_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
seus_spri <- read_csv(here::here("data_processing_rcode","output","python", "SEUS_SPR_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
seus_sum <- read_csv(here::here("data_processing_rcode","output","python", "SEUS_SUM_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
wc_ann <- read_csv(here::here("data_processing_rcode","output","python", "WC_ANN_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
wc_tri <- read_csv(here::here("data_processing_rcode","output","python", "WC_TRI_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)

data <- rbind(bfish, ai, ebs, gmex, goa, nbs, neus_fall, neus_spri, seus_fall, seus_spri, seus_sum, wc_ann, wc_tri)
```

## Data Processing


### Biomass percentile
This section captures the data by calculating percentile/rank of biomass of a specific species, compared to all the species biomass in that survey region and survey year.

```{r prep}
data$survey <- ifelse(data$region == "Aleutian Islands", "Aleutian Islands Bottom Trawl Survey",
                         ifelse(data$region == "Eastern Bering Sea", "Eastern Bering Sea Crab/Groundfish Bottom Trawl Survey",
                                ifelse(data$region == "Northern Bering Sea", "Northern Bering Sea Crab/Groundfish Survey - Eastern Bering Sea Shelf Survey Extension",
                                       ifelse(data$region == "Gulf of Alaska", "Gulf of Alaska Bottom Trawl Survey",
                                              ifelse(data$region == "Gulf of Mexico", "Gulf of Mexico Summer Shrimp/Groundfish Survey",
                                                     ifelse(data$region == "Northeast US Fall", "NEFSC Fall Bottom Trawl",
                                                            ifelse(data$region == "Northeast US Spring", "NEFSC Spring Bottom Trawl",
                                                                   ifelse(data$region == "Southeast US Fall", "SEAMAP Fall Coastal Trawl Survey",
                                                                          ifelse(data$region == "Southeast US Spring", "SEAMAP Spring Coastal Trawl Survey",
                                                                                 ifelse(data$region == "Southeast US Summer", "SEAMAP Summer Coastal Trawl Survey",
                                                                                        ifelse(data$region == "West Coast Annual", "West Coast Bottom Trawl Annual",
                                                                                               ifelse(data$region == "West Coast Triennial", "West Coast Bottom Trawl Triennial",
                                                                                                      ifelse(data$region == "Hawaii", "Bottomfish Fishery-Independent Survey in Hawaii (BFISH)",
                                                                                                             ifelse(data$region == "Eastern and Northern Bering Sea", NA, NA))))))))))))))

data_update <- data %>%
  filter(!is.na(survey)) %>%
  mutate(region_old = region) %>%
  select(-region)

data_update$region <- ifelse(data_update$region_old == "Aleutian Islands", "Aleutian Islands",
                             ifelse(data_update$region_old == "Eastern Bering Sea", "Eastern Bering Sea",
                                    ifelse(data_update$region_old == "Northern Bering Sea", "Northern Bering Sea",
                                           ifelse(data_update$region_old == "Gulf of Alaska", "Gulf of Alaska",
                                                  ifelse(data_update$region_old == "Gulf of Mexico", "Gulf of Mexico",
                                                         ifelse(data_update$region_old == "Northeast US Fall", "Northeast US",
                                                                ifelse(data_update$region_old == "Northeast US Spring", "Northeast US",
                                                                       ifelse(data_update$region_old == "Southeast US Fall", "Southeast US",
                                                                              ifelse(data_update$region_old == "Southeast US Spring", "Southeast US",
                                                                                     ifelse(data_update$region_old == "Southeast US Summer", "Southeast US",
                                                                                            ifelse(data_update$region_old == "West Coast Annual", "West Coast",
                                                                                                   ifelse(data_update$region_old == "Hawaii", "Hawai'i Islands",
                                                                                                          ifelse(data_update$region_old == "West Coast Triennial", "West Coast", NA)))))))))))))

```

We calculate total biomass for each species in each year for each survey. Then we remove zero biomass records because these values would skew percentile calculations in the following step. These will be added back in after the percentile calculations.
```{r}
data_sum <- data_update %>%
  select(region, survey, spp, year, common, wtcpue) %>%
  group_by(region, survey, year, spp, common) %>%
  summarise(wtcpue = sum(wtcpue))

data_sum_zeros <- data_sum %>% 
  filter(wtcpue == 0)

data_sum_nozeros <- data_sum %>% 
  filter(wtcpue > 0)
```

Using the `cume_dist()` function here (as opposed to the `percent_rank()` function) to rank biomass values as percentiles because this method will not produce a percentile of zero. Percentiles are calculated for a particular species, in comparison to all the biomass values for all species in a survey/survey region, across all survey years.
```{r percentile, message = FALSE}

data_rank_nozeros <- data_sum_nozeros %>%
  group_by(region, survey) %>%
  mutate(percentile = cume_dist(wtcpue))

```

Then, we bring the zero biomass rows back in after the percentiles are calculated and `rbind` them to the data set with percentiles calculated. Species that have zero biomass in a survey region for a survey year will have a percentile value of zero. Any species that has a survey biomass > 0 for a survey year will have a ranked percentile value, in comparison to all the biomass values in that survey region across all survey years.
```{r}

data_rank <- rbind(data_rank_nozeros, data_sum_zeros) %>% 
  dplyr::rename(Region = region,
                SurveyName = survey,
                Common = common,
                Species = spp,
                Year = year,
                WTCPUE = wtcpue,
                Percentile = percentile) %>% 
  mutate(Percentile = ifelse(is.na(Percentile), 0, Percentile))
  
```

The percentile values are then binned as being "Absent" (biomass and percentile of 0), "Rare" (< 10th percentile), "Less Common" (10th - 25th percentile), "Common" (25th - 75th percentile), "Abundant" (75th - 90th percentile), or "Highly Abundant" (> 90th percentile).
```{r binning}

data_rank$Bin <- ifelse(data_rank$Percentile == 0.0, "Absent",
                        ifelse(data_rank$Percentile > 0.0 & data_rank$Percentile <= 0.10, "Rare",
                               ifelse(data_rank$Percentile > 0.10 & data_rank$Percentile <= 0.25, "Less Common",
                                      ifelse(data_rank$Percentile > 0.25 & data_rank$Percentile <= 0.75, "Common",
                                             ifelse(data_rank$Percentile > 0.75 & data_rank$Percentile <= 0.90, "Abundant",
                                                    ifelse(data_rank$Percentile > 0.90, "Highly Abundant", NA))))))

```

```{r presence_absence}

data_rank$Absence_Presence <- ifelse(data_rank$WTCPUE == 0, "0",
                                     ifelse(data_rank$WTCPUE > 0, "1", "NA"))

#Absence is 0 and Presence is 1

```


```{r test_viz, message=FALSE, eval=FALSE}

ggplot(data_rank, aes(Percentile)) +
  # scale_colour_brewer(palette = "Spectral") +
  geom_histogram() +
  facet_wrap(vars(SurveyName)) +
  theme_minimal()

```
### Presence in hauls
This section will calculate the number of hauls that a species is present in, per survey and per year. Measuring the presence in hauls will capture the prevalence of that species in the survey (i.e., how prominent is this species in the survey?), over time.


```{r functions, message = FALSE}

present_every_year <- function(dat, ...){
  presyr <- dat %>%
    filter(wtcpue > 0) %>%
    group_by(...) %>%
    summarise(pres = n())
  return(presyr)
}

num_hauls_year <- function(dat, ...){
  haulsyr <- dat %>%
    select(c(region, survey, haulid, year)) %>%
    distinct() %>%
    group_by(...) %>%
    summarise(hauls = n())
  return(haulsyr)
}

```

We calculate the number of hauls total (in each survey and survey year) and the number of hauls for which a particular species was caught. We then also calculate the proportion of total hauls each species was caught in (for each survey and survey year).
```{r prep2}

presyr <- present_every_year(data_update, region, survey, spp, common, year)

haulsyr <- num_hauls_year(data_update, region, survey, year)

# data frame with the number of hauls a species is present for, 
preshaul <- left_join(presyr, haulsyr, by=c("region", "survey", "year")) %>%
  mutate(proportion=((pres/hauls)*100))

data_haul <- preshaul %>% 
  select(-hauls) %>% 
  dplyr::rename(Region = region,
                Species = spp,
                Common = common,
                SurveyName = survey,
                Year = year,
                Presence = pres,
                Proportion = proportion)

```


### Binding haul count to percentiles

Using left_join to add the `Presence` and `Proportion` values from `data_haul` to the corresponding survey and species in `data_rank`. Any zero biomass/percentile will turn up as `NA` values in the haul presence column when it's joined. We have converted these `NA`'s to zeros because those are instances in which the species was not landed in the survey. **This builds our full data set of results.**

```{r}
data_full <- data_rank %>% 
  left_join(data_haul, by = c("Region", "SurveyName", "Species", "Common", "Year")) %>% 
  mutate(Presence = ifelse(is.na(Presence), 0, Presence)) %>% 
  mutate(Proportion = ifelse(is.na(Proportion), 0, Proportion))
  
```

```{r, eval=FALSE}
ggplot(data_full, aes(WTCPUE)) +
  # scale_colour_brewer(palette = "Spectral") +
  geom_histogram() +
  facet_wrap(vars(SurveyName)) +
  theme_minimal()
```


## Vizualizations

```{r}
library(tidyverse)
library(hrbrthemes)
library(viridis)
library(plotly)
library(heatmaply)
```

The goal of this data processing is for users to be able to clearly see trends in the prevalence of species in surveys over time so that they can notice species that might be emerging or disappearing in a region. We have chosen two example surveys/regions for testing visualizations of data processing: the Northeast Spring Bottom Trawl Survey and the Aleutian Island Bottom Trawl Survey.


*The example visualizations below are depicted as heat maps because of their similarities to the mocked-up version of the module on DisMAP*

**Note: These visualizations are interactive. To see the values depicted in each cell, simply hover your cursor over the plot. To zoom in on a set of species or years, hold and drag your cursor to draw a box around the desired region.**

### NEFSC Spring Example Heatmaps
The "Haul Frequency" figure below reflects the number of hauls that each species was present in, across surveyed years for the Northeast Spring Bottom Trawl Survey. 

*(In the live version on the module, the zero values here would be coded to be a different color (e.g. white or gray) to clearly distinguish them from non-zero values)*
```{r, eval=FALSE}

#These will need to be adjusted to list the common name

data_1 <- data_full %>%
  filter(SurveyName == "NEFSC Spring Bottom Trawl") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Percentile, -Bin, -Proportion, -Absence_Presence) %>% 
  pivot_wider(names_from = Year, values_from = Presence)

# data_1$Year <- as.character(data_1$Year)

mat_1 <- as.matrix(data_1)
rownames(mat_1) <- mat_1[,1]
mat_1 <- as.data.frame(mat_1) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)
# mat_1 <- as.matrix(mat_1) %>% 
  # mutate_if(is.character, as.numeric)

p1 <- heatmaply(mat_1,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 1: NEFSC Spring Bottom Trawl (Haul Freq.)",
                # scale = "column",
                # margins = c(60,100,40,20),
                # grid_color = "white",
                # grid_width = 0.000005,
                # titleX = FALSE,
                hide_colorbar = FALSE,
                # branches_lwd = 0.1,
                label_names = c("Species", "Year", "Presence"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_1),
                labRow = rownames(mat_1),
                heatmap_layers = theme(axis.line = element_blank())
                )

p1
```

The "Haul Proportion" figure below reflects the proportion of hauls that each species was present in (hauls present divided by total hauls in a survey), across surveyed years for the Northeast Spring Bottom Trawl Survey.

*(In the live version on the module, the zero values here would be coded to be a different color (e.g. white or gray) to clearly distinguish them from non-zero values)*
```{r, eval=FALSE}
data_2 <- data_full %>%
  filter(SurveyName == "NEFSC Spring Bottom Trawl") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Presence, -Bin, -Percentile, -Absence_Presence) %>% 
  pivot_wider(names_from = Year, values_from = Proportion)

# data_1$Year <- as.character(data_1$Year)

mat_2 <- as.matrix(data_2)
rownames(mat_2) <- mat_2[,1]
mat_2 <- as.data.frame(mat_2) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)


p2 <- heatmaply(mat_2,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 2: NEFSC Spring Bottom Trawl (Haul Proportion)",
                hide_colorbar = FALSE,
                label_names = c("Species", "Year", "Percentile"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_2),
                labRow = rownames(mat_2),
                heatmap_layers = theme(axis.line = element_blank())
                )

p2
```


The "Percentiles" figure below reflects the biomass of each species, calculated as a percentile of all the species biomass values across an entire survey. Percentiles are calculated for all survey years for the Northeast Spring Bottom Trawl Survey.

*(In the live version on the module, the zero values here would be coded to be a different color (e.g. white or gray) to clearly distinguish them from non-zero values)*
```{r, eval=FALSE}
data_3 <- data_full %>%
  filter(SurveyName == "NEFSC Spring Bottom Trawl") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Presence, -Bin, -Proportion, -Absence_Presence) %>% 
  pivot_wider(names_from = Year, values_from = Percentile)

# data_1$Year <- as.character(data_1$Year)

mat_3 <- as.matrix(data_3)
rownames(mat_3) <- mat_3[,1]
mat_3 <- as.data.frame(mat_3) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)
# mat_1 <- as.matrix(mat_1) %>% 
  # mutate_if(is.character, as.numeric)

p3 <- heatmaply(mat_3,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 3: NEFSC Spring Bottom Trawl (Percentiles)",
                hide_colorbar = FALSE,
                label_names = c("Species", "Year", "Percentile"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_3),
                labRow = rownames(mat_3),
                heatmap_layers = theme(axis.line = element_blank())
                )

p3
```

The "Binned Percentile" figure below reflects the Percentile values in Ex 3 figure (above) binned as "Absent" (biomass and percentile of 0), "Rare" (< 10th percentile), "Less Common" (10th - 25th percentile), "Common" (25th - 75th percentile), "Abundant" (75th - 90th percentile), of "Highly Abundant" (> 90th percentile). Percentile Bins are calculated for all survey years for the Northeast Spring Bottom Trawl Survey.
```{r, eval=FALSE}
data_4 <- data_full %>%
  filter(SurveyName == "NEFSC Spring Bottom Trawl") %>% 
  ungroup() %>% 
  select(Region, SurveyName, Year, Species, Common, Bin)

data_4$Bin <- factor(data_4$Bin, levels = c('Absent', 'Rare', 'Less Common', 'Common', 'Abundant', 'Highly Abundant'))

p4 <- ggplot(data_4, aes(Year, Common)) +
  geom_tile(aes(fill= Bin)) +
  ggtitle("Ex 4: NEFSC Spring Bottom Trawl (Binned Percentiles)") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  theme(axis.text.y = element_text(size = 4))


ggplotly(p4)
```


### Aleutian Islands Example Heatmaps
The "Haul Frequency" figure below reflects the number of hauls that each species was present in, across surveyed years for the Aleutian Islands Bottom Trawl Survey.

*(In the live version on the module, the zero values here would be coded to be a different color (e.g. white or gray) to clearly distinguish them from non-zero values)*
```{r, eval=FALSE}
data_5 <- data_full %>%
  filter(SurveyName == "Aleutian Islands Bottom Trawl Survey") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Percentile, -Bin, -Proportion, -Absence_Presence) %>% 
  pivot_wider(names_from = Year, values_from = Presence)

# data_1$Year <- as.character(data_1$Year)

mat_5 <- as.matrix(data_5)
rownames(mat_5) <- mat_5[,1]
mat_5 <- as.data.frame(mat_5) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)


p5 <- heatmaply(mat_5,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 5: Aleutian Islands Bottom Trawl Survey (Haul Freq.)",
                hide_colorbar = FALSE,
                label_names = c("Species", "Year", "Presence"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_5),
                labRow = rownames(mat_5),
                heatmap_layers = theme(axis.line = element_blank())
                )

p5
```
The "Haul Proportion" figure below reflects the proportion of hauls that each species was present in (hauls present divided by total hauls in a survey), across surveyed years for the Aleutian Islands Bottom Trawl Survey.

*(In the live version on the module, the zero values here would be coded to be a different color (e.g. white or gray) to clearly distinguish them from non-zero values)*
```{r, eval=FALSE}
data_6 <- data_full %>%
  filter(SurveyName == "Aleutian Islands Bottom Trawl Survey") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Presence, -Bin, -Percentile, -Absence_Presence) %>% 
  pivot_wider(names_from = Year, values_from = Proportion)

# data_1$Year <- as.character(data_1$Year)

mat_6 <- as.matrix(data_6)
rownames(mat_6) <- mat_6[,1]
mat_6 <- as.data.frame(mat_6) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)


p6 <- heatmaply(mat_6,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 6: Aleutian Islands (Haul Proportion)",
                hide_colorbar = FALSE,
                label_names = c("Species", "Year", "Percentile"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_6),
                labRow = rownames(mat_6),
                heatmap_layers = theme(axis.line = element_blank())
                )

p6
```

The "Percentiles" figure below reflects the biomass of each species, calculated as a percentile of all the species biomass values across an entire survey. Percentiles are calculated for all survey years for the Aleutian Islands Bottom Trawl Survey.

*(In the live version on the module, the zero values here would be coded to be a different color (e.g. white or gray) to clearly distinguish them from non-zero values)*
```{r, eval=FALSE}
data_7 <- data_full %>%
  filter(SurveyName == "Aleutian Islands Bottom Trawl Survey") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Presence, -Bin, -Proportion, -Absence_Presence) %>% 
  pivot_wider(names_from = Year, values_from = Percentile)

# data_1$Year <- as.character(data_1$Year)

mat_7 <- as.matrix(data_7)
rownames(mat_7) <- mat_7[,1]
mat_7 <- as.data.frame(mat_7) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)
# mat_1 <- as.matrix(mat_1) %>% 
  # mutate_if(is.character, as.numeric)

p7 <- heatmaply(mat_7,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 7: Aleutian Islands Bottom Trawl Survey (Percentiles)",
                hide_colorbar = FALSE,
                label_names = c("Species", "Year", "Percentile"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_7),
                labRow = rownames(mat_7),
                heatmap_layers = theme(axis.line = element_blank())
                )

p7
```

The "Binned Percentile" figure below reflects the Percentile values in Ex 3 figure (above) binned as "Absent" (biomass and percentile of 0), "Rare" (< 10th percentile), "Less Common" (10th - 25th percentile), "Common" (25th - 75th percentile), "Abundant" (75th - 90th percentile), of "Highly Abundant" (> 90th percentile). Percentile Bins are calculated for all survey years for the Aleutian Islands Bottom Trawl Survey.
```{r, eval=FALSE}
data_8 <- data_full %>%
  filter(SurveyName == "Aleutian Islands Bottom Trawl Survey") %>% 
  ungroup()

data_8$Bin <- factor(data_8$Bin, levels = c('Absent', 'Rare', 'Less Common', 'Common', 'Abundant', 'Highly Abundant'))

p8 <- ggplot(data_8, aes(Year, Common)) +
  geom_tile(aes(fill= Bin)) +
  ggtitle("Ex 8: Aleutian Islands (Binned Percentiles)") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  theme(axis.text.y = element_text(size = 4))


ggplotly(p8)
```

### All Surveys - Facet Wrapped

```{r scratch 1, eval=FALSE}
data_all <- data_full

data_all$Bin <- factor(data_all$Bin, levels = c('Absent', 'Rare', 'Less Common', 'Common', 'Abundant', 'Highly Abundant'))

p_all <- ggplot(data_all, aes(Year, Common)) +
  geom_tile(aes(fill= Bin)) +
  # ggtitle("All Surveys (Binned Percentiles)") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  # theme(axis.text.y = element_text(size = 8)) +
  facet_wrap(~SurveyName, nrow = 6)


ggplotly(p_all)


```

```{r scratch 2, eval=FALSE, message=FALSE, warning=FALSE}

#### This takes a really long time to knit so be prepared! ####

data_all <- data_full %>%
  ungroup()

surveys <- unique(data_all$SurveyName)

plotlist <- list()

for(v in surveys) {
  
  dat <- data_all %>% 
    filter(SurveyName == v)
  
  dat$Bin <- factor(dat$Bin, levels = c('Absent', 'Rare', 'Less Common', 'Common', 'Abundant', 'Highly Abundant'))
  
  p <- ggplot(dat, aes(Year, Common)) +
    geom_tile(aes(fill= Bin)) +
    ggtitle(paste(v)) +
    theme_minimal() +
    scale_fill_viridis(discrete=TRUE, option="viridis")
    # theme(axis.text.y = element_text(size = 8))
  
  # Convert ggplot to ggplotly and display
  
  plotlist[[v]] <- ggplotly(p)
  
}

htmltools::tagList(setNames(plotlist, NULL))

```


## Cummulative assessment



```{r}
data_cumm <- data_full %>% 
  select(Region, SurveyName, Year, Species, Common, Absence_Presence)

data_cumm$Absence_Presence <- as.numeric(data_cumm$Absence_Presence)
```

```{r}
holding <- data.frame(SurveyName = character(), Species = character(), Year = numeric(), Diff = numeric(), stringsAsFactors = FALSE)


surveys <- unique(data_cumm$SurveyName)

for(v in surveys) {

  firstfilt <- data_cumm %>%
    filter(SurveyName == v)

  spps <- unique(firstfilt$Species)

  for (p in spps) {

    myfilt <- firstfilt %>%
      filter(Species == p)

    years <- c(myfilt$Year)
    years <- years[order(years)]


    for (i in 1:(length(years)-1)) {

      var_1 <- myfilt %>%
        filter(Year == years[i])

      var_2 <- myfilt %>%
        filter(Year == years[i+1])

      Diff <- var_2$Absence_Presence[1] - var_1$Absence_Presence[1]

      #this step (below) might be redundant
      # survey <- paste(v)
      # spp <- paste(p)
      # Diff <- diff

      temp <- data.frame(SurveyName = v, Species = p, Year = years[i+1], Diff = Diff, stringsAsFactors = FALSE)

      holding <- rbind(holding, temp)

    }
  }
}

```


```{r adding common names}
# Creating a speices list will allow me to join in the common names at the end of the next chunk
spp_list <- distinct(data_full %>% 
  ungroup() %>% 
  select(SurveyName, Species, Common))

```

```{r}
data_ce_col <- holding %>% 
  filter(Diff == 1) %>% 
  group_by(SurveyName, Species) %>% 
  summarise(col = n())

data_ce_ext <- holding %>% 
  filter(Diff == -1) %>% 
  group_by(SurveyName, Species) %>% 
  summarise(ext = n())

data_ce_stable <- holding %>% 
  filter(Diff == 0) %>% 
  group_by(SurveyName, Species) %>% 
  summarise(stable = n())

data_ce <- data_ce_stable %>%
  full_join(data_ce_col, by = c("SurveyName", "Species")) %>% 
  full_join(data_ce_ext, by = c("SurveyName", "Species")) %>% 
  replace(is.na(.), 0) %>% 
  select(-stable) %>% 
  left_join(spp_list, by = c("SurveyName", "Species")) %>% 
  select(SurveyName, Species, Common, col, ext)
```


```{r grouped absence/presence df}
#creating a data frame that groups the tally of absences vs presences to help with definitions of trends
# Reminder for `Absence_Presence` column: Absence is 0 and Presence is 1
data_ap_a <- data_cumm %>% 
  filter(Absence_Presence == 0) %>% 
  group_by(Region, SurveyName, Species, Common) %>% 
  summarise(Absence = n())

data_ap_p <- data_cumm %>% 
  filter(Absence_Presence == 1) %>% 
  group_by(Region, SurveyName, Species, Common) %>% 
  summarise(Presence = n())

data_ap <- data_ap_p %>% 
  full_join(data_ap_a, by = c("Region", "SurveyName", "Species", "Common")) %>% 
  ungroup() %>% 
  mutate(Absence = ifelse(is.na(Absence), 0, Absence))
```

```{r df col/ext and ab/pre}

data_ce_ap <- data_ce %>% 
  left_join(data_ap, by = c("SurveyName", "Species", "Common")) %>% 
  select(Region, SurveyName, Species, Common, col, ext, Absence, Presence) %>% 
  # group_by(Region, SurveyName, Species, Common) %>% 
  mutate(total_ap = Absence + Presence) %>% 
  mutate(pres_prob = Presence/total_ap) %>% 
  ungroup()
```

```{r function add_trend_category}

add_trend_category <- function(data_full) {
  data_full %>%
    arrange(Region, SurveyName, Species, Common, Year) %>%
    group_by(Region, SurveyName, Species, Common) %>%
    group_modify(~{
      df <- .x
      n_years <- nrow(df)
      abs_vec <- df$Absence_Presence
      percent_present <- sum(abs_vec == 1, na.rm = TRUE) / n_years

      # Indices for first/last half
      half_n <- floor(n_years / 2)
      first_half_idx <- seq_len(half_n)
      last_half_idx <- seq(n_years - half_n + 1, n_years)

      abs_first_half <- if(length(first_half_idx) > 0) sum(abs_vec[first_half_idx] == 1, na.rm = TRUE) else NA_real_
      abs_last_half <- if(length(last_half_idx) > 0) sum(abs_vec[last_half_idx] == 1, na.rm = TRUE) else NA_real_
      percent_first_half <- if(length(first_half_idx) > 0) abs_first_half / length(first_half_idx) else NA_real_
      percent_last_half <- if(length(last_half_idx) > 0) abs_last_half / length(last_half_idx) else NA_real_

      # Indices for last 5 years
      last5_n <- min(5, n_years)
      last5_idx <- seq(n_years - last5_n + 1, n_years)
      abs_last5 <- if(length(last5_idx) > 0) sum(abs_vec[last5_idx] == 1, na.rm = TRUE) else NA_real_

      trend_category <- case_when(
        percent_present >= 0.85 & abs_last5 >= 4 ~ "Persistently Present",
        percent_present > 0.5 & abs_last5 >= 4 &
          percent_last_half >= 0.75 &
          abs_first_half <= abs_last_half ~ "Established",
        percent_present <= 0.5 & abs_last5 <= 1 &
          percent_last_half <= 0.35 &
          abs_first_half >= abs_last_half ~ "Disappeared",
        abs_last5 <= 1 & percent_first_half <= 0.5 ~ "Potentially Emerging",
        abs_last5 >= 4 & percent_first_half >= 0.5 ~ "Potentially Disappearing",
        percent_present >= 0.5 ~ "Sporadic - Primarily Present",
        percent_present < 0.5 ~ "Sporadic - Primarily Absent",
        TRUE ~ NA_character_
      )
      df$TrendCategory <- trend_category
      df
    }) %>%
    ungroup()
}

# Usage:
data_full_summary <- add_trend_category(data_full) %>% 
  select(Region, SurveyName, Species, Common, TrendCategory) %>% 
  distinct()
```


```{r, eval=FALSE}
#' Get species that show up and remain (Batt et al., 2017)
#' 
#'  n_yrs_start after this many years, species seen for the first time "show up"; acts as a burn-in
#'  n_yrs_remain how many years must be remaining in the time series after a species "shows up" to evaluate it as "sticking around"
#'  n_yrs_miss_after how many years the species can be missing during remaining (post show-up) years and still be considered to "stick around"
#' 
#' Details:
#' Function looks for species that appear after the second year, but before the final 5 years, and that in the remaining years (of which there must be at least 5) the species is observed in at least every year but 1. So a species that shows up after many years of sampling, and then is seen every year thereafter, will be returned by this function. Those species might be showing up and sticking around b/c of changing detection by the survey (I'd expect species to come on the scene more slowly, such that after it first shows up, there should still be some years it isn't observed)
#' 
#' Returns data.table containing the region, year of appearance, species, stats for how long and how consistently that species showed up.
#' 
una <- unique

get_show_up_spp <- function(data_all, n_yrs_start=2, n_yrs_remain=5, n_yrs_miss_after=1){
	data_all <- data_all[!is.na(SurveyName) & !is.na(Species) & !is.na(Year)]
  added_spp <- data_all[, j={
		Years <- Year[order(Year)]
	  old <- .SD[Year==una(Year)[1],una(Species)]
		new <- list()
		uyr <- .SD[,una(Year)]
		for(y in 2:length(Year)){
			td <- .SD[(Year)==uyr[y]]
			t_spp <- td[,una(Species)]
			spp_added <- c(NA, setdiff(t_spp, old))
			old <- una(c(old,t_spp))
			new[[y]] <- data.table(Year=td[,una(Year)], Species=spp_added)

		}

		rbindlist(new)

	}, by="SurveyName"]

	n_added_spp <- added_spp[,list(n_new_spp=length(Species)-1), by=c("SurveyName","Year")]

	t_X <- copy(data_all)
	setkey(t_X, SurveyName, Species)
	t_added_spp <- copy(added_spp[!is.na(Species)])
	setkey(t_added_spp, SurveyName, Species)
	t_added_spp[,year_added:=Year]
	t_added_spp[,Year:=NULL]

	X_added <- merge(t_X, t_added_spp, by=c("SurveyName","Species"))
	spp_added_freq <- X_added[,j={
		yrs <- sort(una(Year))
		uya <- una(year_added)
		.SD[,list(
			year_added=una(year_added),
			total_years = length(yrs)+1,
			years_elapsed=sum(yrs <= una(year_added))+1,
			years_remaining=sum(yrs > una(year_added)),
			years_seen_after=length(Year)-1
		), by="Species"]

	}, by=c("SurveyName")]

	show_up_spp <- spp_added_freq[years_elapsed>=n_yrs_start & ((years_remaining - years_seen_after)<=n_yrs_miss_after) & years_remaining >=n_yrs_remain]
	
	return(show_up_spp)
}
```

```{r}
library(data.table)
data_all <- as.data.table(data_all %>% select(SurveyName, Species, Year, Common, WTCPUE, Absence_Presence))
result <- get_show_up_spp(data_all)
```

**Definitions**

- Persistently Present: Is observed in surveys and has always been observed in surveys
- Established: It wasn’t observed in surveys and now it’s definitely observed in surveys
- Emerging: It wasn’t really observed in surveys and now it’s maybe beginning to be observed in surveys
- Potentially Disappearing: It was observed in surveys in some capacity but now might be possibly leaving
- Disappeared: It was observed in surveys in some capacity but has now fully left
- Sporadic - Primarily Present: Mix of present and absent observations throughout time, but there is more presences than absences
- Sporadic - Primarily Absent: Mix of present and absent observations throughout time, but there is more absences than presences


```{r definitions}

data_ce_ap$Trend <- ifelse(data_ce_ap$col == 1 & data_ce_ap$ext == 0, "Emerging", #third rule
                           ifelse(data_ce_ap$col == 0 & data_ce_ap$ext == 1, "Leaving", #fourth rule
                                  ifelse(data_ce_ap$Absence == 0, "Persistent", #move this to top rule
                                         ifelse(data_ce_ap$col > 2 & data_ce_ap$ext > 2, "Sporadic", #second rule
                                                ifelse(data_ce_ap$ext <= 2 & data_ce_ap$pres_prob >= 0.85, "Stable", 0))))) #both stable definitions 

# Stable here is being defined as similar to Persistent but with a little flexibility (allowing for a random absence here or there)

# check the species left over that aren't captured by these definitions
myfilt <- data_ce_ap %>% filter(Trend == 0)

```

