---
title: 'Species Persistence: Options'
author: "Claire Gonzales (NOAA Affiliate)"
date: "2025-04-29"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    theme: lumen
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)

library(here)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(readr)
```


## Background

This document presents various analyses for evaluating species persistence (emergence, consistence persistence, or removal). Feedback on the usefulness of these analyses and visualization would be greatly appreciated.

The goals for this indicator are four-fold:

* Visualize changes in biomass (or presence/absence) for a particular species, from years to year
* Categorize prevalence as being: 
  + emerging, 
  + disappearing, 
  + stable,
  + or sporadic
* Measure cumulative trend in prevalence of a particular species, across all survey years
* Categorize trend as:
  + increasing, 
  + decreasing,
  + or consistent


```{r wrangling, message = FALSE}
# data <- data.frame(base::readRDS(file = here::here("data_processing_rcode/output/data_clean/alldata_withzeros.rds")))

## creating a dataset for last year. Normally, data would be pulled in from the RDS and titled `data`, as shown above ##

bfish <- read_csv(here::here("data_processing_rcode/data", "BFISH_DisMAP_2024_update_v2.csv")) 

ai <- read_csv(here::here("data_processing_rcode","output","python", "AI_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
ebs <- read_csv(here::here("data_processing_rcode","output","python", "EBS_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
gmex <- read_csv(here::here("data_processing_rcode","output","python", "GMEX_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
goa <- read_csv(here::here("data_processing_rcode","output","python", "GOA_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
nbs <- read_csv(here::here("data_processing_rcode","output","python", "NBS_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
neus_fall <- read_csv(here::here("data_processing_rcode","output","python", "NEUS_FAL_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
neus_spri <- read_csv(here::here("data_processing_rcode","output","python", "NEUS_SPR_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
seus_fall <- read_csv(here::here("data_processing_rcode","output","python", "SEUS_FAL_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
seus_spri <- read_csv(here::here("data_processing_rcode","output","python", "SEUS_SPR_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
seus_sum <- read_csv(here::here("data_processing_rcode","output","python", "SEUS_SUM_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
wc_ann <- read_csv(here::here("data_processing_rcode","output","python", "WC_ANN_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)
wc_tri <- read_csv(here::here("data_processing_rcode","output","python", "WC_TRI_survey.csv")) %>%
  select(region, haulid, year, spp, common, wtcpue, stratum, stratumarea, lat, lon, depth)

data <- rbind(bfish, ai, ebs, gmex, goa, nbs, neus_fall, neus_spri, seus_fall, seus_spri, seus_sum, wc_ann, wc_tri)
```


## Biomass percentile
This section captures the data by calculating percentile/rank of biomass of a specific species, compared to all the species biomass in that region and survey.

```{r prep}
data$survey <- ifelse(data$region == "Aleutian Islands", "Aleutian Islands Bottom Trawl Survey",
                         ifelse(data$region == "Eastern Bering Sea", "Eastern Bering Sea Crab/Groundfish Bottom Trawl Survey",
                                ifelse(data$region == "Northern Bering Sea", "Northern Bering Sea Crab/Groundfish Survey - Eastern Bering Sea Shelf Survey Extension",
                                       ifelse(data$region == "Gulf of Alaska", "Gulf of Alaska Bottom Trawl Survey",
                                              ifelse(data$region == "Gulf of Mexico", "Gulf of Mexico Summer Shrimp/Groundfish Survey",
                                                     ifelse(data$region == "Northeast US Fall", "NEFSC Fall Bottom Trawl",
                                                            ifelse(data$region == "Northeast US Spring", "NEFSC Spring Bottom Trawl",
                                                                   ifelse(data$region == "Southeast US Fall", "SEAMAP Fall Coastal Trawl Survey",
                                                                          ifelse(data$region == "Southeast US Spring", "SEAMAP Spring Coastal Trawl Survey",
                                                                                 ifelse(data$region == "Southeast US Summer", "SEAMAP Summer Coastal Trawl Survey",
                                                                                        ifelse(data$region == "West Coast Annual", "West Coast Bottom Trawl Annual",
                                                                                               ifelse(data$region == "West Coast Triennial", "West Coast Bottom Trawl Triennial",
                                                                                                      ifelse(data$region == "Hawaii", "Bottomfish Fishery-Independent Survey in Hawaii (BFISH)",
                                                                                                             ifelse(data$region == "Eastern and Northern Bering Sea", NA, NA))))))))))))))

data_update <- data %>%
  filter(!is.na(survey)) %>%
  mutate(region_old = region) %>%
  select(-region)

data_update$region <- ifelse(data_update$region_old == "Aleutian Islands", "Aleutian Islands",
                             ifelse(data_update$region_old == "Eastern Bering Sea", "Eastern Bering Sea",
                                    ifelse(data_update$region_old == "Northern Bering Sea", "Northern Bering Sea",
                                           ifelse(data_update$region_old == "Gulf of Alaska", "Gulf of Alaska",
                                                  ifelse(data_update$region_old == "Gulf of Mexico", "Gulf of Mexico",
                                                         ifelse(data_update$region_old == "Northeast US Fall", "Northeast US",
                                                                ifelse(data_update$region_old == "Northeast US Spring", "Northeast US",
                                                                       ifelse(data_update$region_old == "Southeast US Fall", "Southeast US",
                                                                              ifelse(data_update$region_old == "Southeast US Spring", "Southeast US",
                                                                                     ifelse(data_update$region_old == "Southeast US Summer", "Southeast US",
                                                                                            ifelse(data_update$region_old == "West Coast Annual", "West Coast",
                                                                                                   ifelse(data_update$region_old == "Hawaii", "Hawai'i Islands",
                                                                                                          ifelse(data_update$region_old == "West Coast Triennial", "West Coast", NA)))))))))))))

```

```{r}
data_sum <- data_update %>%
  select(region, survey, spp, year, common, wtcpue) %>%
  group_by(region, survey, year, spp, common) %>%
  summarise(wtcpue = sum(wtcpue))

data_sum_zeros <- data_sum %>% 
  filter(wtcpue == 0)

data_sum_nozeros <- data_sum %>% 
  filter(wtcpue > 0)
```

Using the `cume_dist()` function here (as opposed to the `percent_rank()` function) to rank biomass values as percentiles because this method will not produce a percentile of zero.
```{r percentile, message = FALSE}

data_rank_nozeros <- data_sum_nozeros %>%
  group_by(region, survey) %>%
  mutate(percentile = cume_dist(wtcpue))

```

Bringing the absent biomass values back in after the percentiles are calculated.
```{r}

data_rank <- rbind(data_rank_nozeros, data_sum_zeros) %>% 
  dplyr::rename(Region = region,
                SurveyName = survey,
                Common = common,
                Species = spp,
                Year = year,
                WTCPUE = wtcpue,
                Percentile = percentile) %>% 
  mutate(Percentile = ifelse(is.na(Percentile), 0, Percentile))
  
```


```{r binning}

data_rank$Bin <- ifelse(data_rank$Percentile == 0.0, "Absent",
                        ifelse(data_rank$Percentile > 0.0 & data_rank$Percentile <= 0.10, "Rare",
                               ifelse(data_rank$Percentile > 0.10 & data_rank$Percentile <= 0.25, "Less Common",
                                      ifelse(data_rank$Percentile > 0.25 & data_rank$Percentile <= 0.75, "Common",
                                             ifelse(data_rank$Percentile > 0.75 & data_rank$Percentile <= 0.90, "Abundant",
                                                    ifelse(data_rank$Percentile > 0.90, "Highly Abundant", NA))))))

```


```{r test_viz, message=FALSE, eval=FALSE}

ggplot(data_rank, aes(Percentile)) +
  # scale_colour_brewer(palette = "Spectral") +
  geom_histogram() +
  facet_wrap(vars(SurveyName)) +
  theme_minimal()

```
## Presence in hauls
This section will calculate the number of hauls that a species is present in, per survey and per year. Measuring the presence in hauls will capture the prevalence of that species in the survey (i.e., how prominent is this species in the survey?), over time.


```{r functions, message = FALSE}

present_every_year <- function(dat, ...){
  presyr <- dat %>%
    filter(wtcpue > 0) %>%
    group_by(...) %>%
    summarise(pres = n())
  return(presyr)
}

num_hauls_year <- function(dat, ...){
  haulsyr <- dat %>%
    select(c(region, survey, haulid, year)) %>%
    distinct() %>%
    group_by(...) %>%
    summarise(hauls = n())
  return(haulsyr)
}

```


```{r prep2}

presyr <- present_every_year(data_update, region, survey, spp, common, year)

haulsyr <- num_hauls_year(data_update, region, survey, year)

# data frame with the number of hauls a species is present for, 
preshaul <- left_join(presyr, haulsyr, by=c("region", "survey", "year")) %>%
  mutate(proportion=((pres/hauls)*100))

data_haul <- preshaul %>% 
  select(-hauls) %>% 
  dplyr::rename(Region = region,
                Species = spp,
                Common = common,
                SurveyName = survey,
                Year = year,
                Presence = pres,
                Proportion = proportion)

```


## Bind haul count to percentiles

Using left_join to add the `Presence` values from `data_haul`. Any zero biomass/percentile will turn up as `NA` values in the haul presence column when it's joined. We have converted these `NA`'s to zeros because those are instances in which the species was not landed in the survey.

```{r}
data_full <- data_rank %>% 
  left_join(data_haul, by = c("Region", "SurveyName", "Species", "Common", "Year")) %>% 
  mutate(Presence = ifelse(is.na(Presence), 0, Presence))
```

```{r, eval=FALSE}
ggplot(data_full, aes(WTCPUE)) +
  # scale_colour_brewer(palette = "Spectral") +
  geom_histogram() +
  facet_wrap(vars(SurveyName)) +
  theme_minimal()
```


## Vizualizations
The goal of this data processing is for users to be able to clearly see trends in the prevalence of species in surveys over time so that they can notice species that might be emerging or disappearing in a region.

### NEFSC Spring Example Heatmaps
```{r}
library(tidyverse)
library(hrbrthemes)
library(viridis)
library(plotly)
library(heatmaply)

#These will need to be adjusted to list the common name

data_1 <- data_full %>%
  filter(SurveyName == "NEFSC Spring Bottom Trawl") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Percentile, -Bin) %>% 
  pivot_wider(names_from = Year, values_from = Presence)

# data_1$Year <- as.character(data_1$Year)

mat_1 <- as.matrix(data_1)
rownames(mat_1) <- mat_1[,1]
mat_1 <- as.data.frame(mat_1) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)
# mat_1 <- as.matrix(mat_1) %>% 
  # mutate_if(is.character, as.numeric)

p1 <- heatmaply(mat_1,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 1: NEFSC Spring Bottom Trawl (Haul Freq.)",
                # scale = "column",
                # margins = c(60,100,40,20),
                # grid_color = "white",
                # grid_width = 0.000005,
                # titleX = FALSE,
                hide_colorbar = FALSE,
                # branches_lwd = 0.1,
                label_names = c("Species", "Year", "Presence"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_1),
                labRow = rownames(mat_1),
                heatmap_layers = theme(axis.line = element_blank())
                )

p1
```

```{r}
data_2 <- data_full %>%
  filter(SurveyName == "NEFSC Spring Bottom Trawl") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Presence, -Bin) %>% 
  pivot_wider(names_from = Year, values_from = Percentile)

# data_1$Year <- as.character(data_1$Year)

mat_2 <- as.matrix(data_2)
rownames(mat_2) <- mat_2[,1]
mat_2 <- as.data.frame(mat_2) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)
# mat_1 <- as.matrix(mat_1) %>% 
  # mutate_if(is.character, as.numeric)

p2 <- heatmaply(mat_2,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 2: NEFSC Spring Bottom Trawl (Percentiles)",
                hide_colorbar = FALSE,
                label_names = c("Species", "Year", "Percentile"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_2),
                labRow = rownames(mat_2),
                heatmap_layers = theme(axis.line = element_blank())
                )

p2
```

```{r}
data_3 <- data_full %>%
  filter(SurveyName == "Aleutian Islands Bottom Trawl Survey") %>% 
  ungroup()

data_3$Bin <- factor(data_3$Bin, levels = c('Absent', 'Less Common', 'Common', 'Abundant', 'Highly Abundant'))

p3 <- ggplot(data_3, aes(Year, Common)) +
  geom_tile(aes(fill= Bin)) +
  ggtitle("Ex 3: NEFSC Spring Bottom Trawl (Binned Percentiles)") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  theme(axis.text.y = element_text(size = 4))


ggplotly(p3)
```

### Aleutian Islands Example Heatmaps

```{r}
data_5 <- data_full %>%
  filter(SurveyName == "Aleutian Islands Bottom Trawl Survey") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Percentile, -Bin) %>% 
  pivot_wider(names_from = Year, values_from = Presence)

# data_1$Year <- as.character(data_1$Year)

mat_5 <- as.matrix(data_5)
rownames(mat_5) <- mat_5[,1]
mat_5 <- as.data.frame(mat_5) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)
# mat_1 <- as.matrix(mat_1) %>% 
  # mutate_if(is.character, as.numeric)

p5 <- heatmaply(mat_5,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 5: Aleutian Islands Bottom Trawl Survey (Haul Freq.)",
                hide_colorbar = FALSE,
                label_names = c("Species", "Year", "Presence"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_5),
                labRow = rownames(mat_5),
                heatmap_layers = theme(axis.line = element_blank())
                )

p5
```



```{r}
data_6 <- data_full %>%
  filter(SurveyName == "Aleutian Islands Bottom Trawl Survey") %>% 
  ungroup() %>% 
  dplyr::select(-Region, -SurveyName, -Common, -WTCPUE, -Presence, -Bin) %>% 
  pivot_wider(names_from = Year, values_from = Percentile)

# data_1$Year <- as.character(data_1$Year)

mat_6 <- as.matrix(data_6)
rownames(mat_6) <- mat_6[,1]
mat_6 <- as.data.frame(mat_6) %>% 
  dplyr::select(-Species) %>% 
  mutate_if(is.character, as.numeric)
# mat_1 <- as.matrix(mat_1) %>% 
  # mutate_if(is.character, as.numeric)

p6 <- heatmaply(mat_6,
                dendrogram = "none",
                xlab = "", 
                ylab = "",
                main = "Ex 6: Aleutian Islands Bottom Trawl Survey (Percentiles)",
                hide_colorbar = FALSE,
                label_names = c("Species", "Year", "Percentile"),
                fontsize_row = 5, 
                fontsize_col = 5,
                labCol = colnames(mat_6),
                labRow = rownames(mat_6),
                heatmap_layers = theme(axis.line = element_blank())
                )

p6
```

```{r}
data_7 <- data_full %>%
  filter(SurveyName == "Aleutian Islands Bottom Trawl Survey") %>% 
  ungroup()

data_7$Bin <- factor(data_7$Bin, levels = c('Absent', 'Less Common', 'Common', 'Abundant', 'Highly Abundant'))

p7 <- ggplot(data_7, aes(Year, Common)) +
  geom_tile(aes(fill= Bin)) +
  ggtitle("Ex 7: Aleutian Islands (Binned Percentiles)") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  theme(axis.text.y = element_text(size = 4))


ggplotly(p7)
```
