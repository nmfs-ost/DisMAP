---
title: "Species Persistence Trend Categorization"
author: "Claire Gonzales (NOAA Affiliate)"
date: "2025-05-22"
output:
  html_document:
    toc: yes
    toc_float: true
    theme: readable
    code_folding: hide
  word_document:
    toc: yes
  pdf_document:
    toc: yes
---

*Code chunks can be viewed by pressing the `SHOW` button on the right hand side of the document*

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)

library(here)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(readr)
library(tidyverse)
library(hrbrthemes)
library(viridis)
library(plotly)
library(heatmaply)
```

## Background

**Feedback on the usefulness of these analyses and visualizations would be greatly appreciated. Specifically, we would appreciate any comments on which set of definitions and parameters that you feel would produce an analysis that is the most useful to DisMAP end-users. Please feel free to contact Melissa and Claire at any time with questions or comments.**

This analysis was completed to supplement the measure of biomass across years in the new Species Persistence Indicator and categorize the biomass trends of a species in each Survey Region over time. We have developed seven categories to define biomass trends of species over time, based on how often that species is observed in a survey or not, and they are as follows:

```{r load data}
# Loading R Data product created in chunk 13 of `Species_Persistence_Brainstorm.Rmd`

data_full <- readRDS(here("data_processing_rcode", "code", "data_full.RData"))
data_ce <-readRDS(here("data_processing_rcode", "code", "data_ce.RData"))

data <- data_full %>% 
  left_join(data_ce, by = c("SurveyName", "Species", "Common"))
```

**Trend Categories**

- Persistently Present: Consistently observed in surveys across years;
- Established: Species previously wasn't observed in surveys and now is consistently observed in surveys;
- Potentially Emerging: Species previously wasn't consistently observed in surveys but is potentially shifting towards being consistently observed;
- Potentially Disappearing: Species was previously observed in surveys but is potentially shifting towards being consistently not observed;
- Disappeared: Species was previously observed in surveys but now is consistently not observed in surveys;
- Sporadic - Primarily Present: Species is observed in over half of surveys but observations are inconsistent; and
- Sporadic - Primarily Absent: Species is observed in less than half of surveys and observations are inconsistent.


The quantitative metrics used to define each category will greatly impact which trends fall into which category. In this document, we have provided five options for applying metrics to the trends, as well as mock visualizations of each option. *If possible, please review the following five options and provide any feedback you might have as to which set of metrics best captures the trend categories.*


## Trend Variations

As a note: these figures are mock-ups and outputs will be optimized and finalized by the DisMAP development team prior to the update.

### Original version

This is the original function that was written. The following "Alternate" versions are variations of this original analysis. This version categorizes species observation trends across years into one of the seven categories, based on the following metrics:

**Category Metrics**

- *Persistently Present*: Observed in >=85% of survey years
- *Established*: Observed in >50% of years, observed more in the second half of the survey years (compared to the first half of survey years), observed in >= 75% of the second half of survey years, and observed in at least four (presence >= 4) of the final five survey years
- *Potentially Emerging*: Observed in <= 50% of years in the first half of survey years and observed in at least four (presence >= 4) of the final five survey years
- *Potentially Disappearing*: Observed in >= 50% of years in the first half of survey years and observed in at most one (presence <= 1) of the final five survey years
- *Disappeared*: Observed in <=50% of years, observed more in the first half of the survey years (compared to the second half of survey years), observed in <= 35% of the second half of survey years, and observed in at most one (presence <= 1) of the final five survey years
- *Sporadic - Primarily Present*: Observed in >=50% of years
- *Sporadic - Primarily Absent*: Observed in <50% of years

```{r function add_trend_category, eval=FALSE}

add_trend_category <- function(data) {
  data %>%
    arrange(Region, SurveyName, Species, Common, Year) %>%
    group_by(Region, SurveyName, Species, Common) %>%
    group_modify(~{
      df <- .x
      n_years <- nrow(df)
      abs_vec <- df$Absence_Presence
      percent_present <- sum(abs_vec == 1, na.rm = TRUE) / n_years

      # Indices for first/last half
      half_n <- floor(n_years / 2)
      first_half_idx <- seq_len(half_n)
      last_half_idx <- seq(n_years - half_n + 1, n_years)

      abs_first_half <- if(length(first_half_idx) > 0) sum(abs_vec[first_half_idx] == 1, na.rm = TRUE) else NA_real_
      abs_last_half <- if(length(last_half_idx) > 0) sum(abs_vec[last_half_idx] == 1, na.rm = TRUE) else NA_real_
      percent_first_half <- if(length(first_half_idx) > 0) abs_first_half / length(first_half_idx) else NA_real_
      percent_last_half <- if(length(last_half_idx) > 0) abs_last_half / length(last_half_idx) else NA_real_

      # Indices for last 5 years
      last5_n <- min(5, n_years)
      last5_idx <- seq(n_years - last5_n + 1, n_years)
      abs_last5 <- if(length(last5_idx) > 0) sum(abs_vec[last5_idx] == 1, na.rm = TRUE) else NA_real_

      trend_category <- case_when(
        percent_present >= 0.85 & abs_last5 >= 4 ~ "Persistently Present",
        percent_present > 0.5 & abs_last5 >= 4 &
          percent_last_half >= 0.75 &
          abs_first_half <= abs_last_half ~ "Established",
        percent_present <= 0.5 & abs_last5 <= 1 &
          percent_last_half <= 0.35 &
          abs_first_half >= abs_last_half ~ "Disappeared",
        abs_last5 >= 4 & percent_first_half <= 0.5 ~ "Potentially Emerging",
        abs_last5 <= 1 & percent_first_half >= 0.5 ~ "Potentially Disappearing",
        percent_present >= 0.5 ~ "Sporadic - Primarily Present",
        percent_present < 0.5 ~ "Sporadic - Primarily Absent",
        TRUE ~ NA_character_
      )
      df$TrendCategory <- trend_category
      df
    }) %>%
    ungroup()
}

# Usage:
data_full_trends <- add_trend_category(data) %>% 
  mutate(Name = paste(Common, SurveyName, sep = "_")) 

data_summary <- add_trend_category(data) %>%
  select(Region, SurveyName, Species, Common, TrendCategory) %>%
  distinct()
```

The following table provides the number of species that fall into each category, using this version of the metrics.
```{r summary table, eval=FALSE}

library(knitr)

trendsummary <- data_summary %>%
  group_by(TrendCategory) %>%
  summarize(n = n())

kable(trendsummary)

```

The following visualizations capture the trends of the species that fall into each category, using this version of metrics.
```{r viz of trends, eval=FALSE}
library(stringr)

#Persistently Present (n=1123)
trend_pres <- data_full_trends %>% 
  filter(TrendCategory == "Persistently Present")

ggplot(trend_pres, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Persistently Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12)) 


#Established (n=146)
trend_estab <- data_full_trends %>% 
  filter(TrendCategory == "Established")

p6 <- ggplot(trend_estab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Established") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p6)


#Disappeared (n=15)
trend_disapp <- data_full_trends %>% 
  filter(TrendCategory == "Disappeared")

ggplot(trend_disapp, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Disappeared") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Potentially Emerging (n=4)
trend_emerging <- data_full_trends %>% 
  filter(TrendCategory == "Potentially Emerging")

ggplot(trend_emerging, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Emerging") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Potentially Disappearing (n=30)
trend_potdis <- data_full_trends %>% 
  filter(TrendCategory == "Potentially Disappearing")

ggplot(trend_potdis, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Disappearing") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Sporadic - Primarily Present (n=94)
trend_spopre <- data_full_trends %>% 
  filter(TrendCategory == "Sporadic - Primarily Present")

p5 <- ggplot(trend_spopre, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p5)


#Sporadic - Primarily Absent (n=38)
trend_spoab <- data_full_trends %>% 
  filter(TrendCategory == "Sporadic - Primarily Absent")

p4 <- ggplot(trend_spoab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Absent") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p4)

```

### Alternate Version 1

This version categorizes species observation trends across years into one of the seven categories, based on the following metrics: 

**Category Metrics**

- *Persistently Present*: Observed in >=85% of survey years
- *Established*: Observed in >50% of years, observed more in the second half of the survey years (compared to the first half of survey years), observed in >= 75% of the second half of survey years, and observed in at least four (presence >= 4) of the final five survey years
- *Potentially Emerging*: Observed in <= 60% of years in the first half of survey years and observed in at least four (presence >= 4) of the final five survey years
- *Potentially Disappearing*: Observed in >= 40% of years in the first half of survey years and observed in at most one (presence <= 1) of the final five survey years
- *Disappeared*: Observed in <=50% of years, observed more in the first half of the survey years (compared to the second half of survey years), observed in <= 35% of the second half of survey years, and observed in at most one (presence <= 1) of the final five survey years
- *Sporadic - Primarily Present*: Observed in >=50% of years
- *Sporadic - Primarily Absent*: Observed in <50% of years

Ultimately, this version loosens the requirements on the "Potentially Emerging" and "Potentially Disappearing" definitions to try and limit the amount of trends that are categorized as "sporadic".
```{r function add_trend_category1, eval=FALSE}

add_trend_category1 <- function(data) {
  data %>%
    arrange(Region, SurveyName, Species, Common, Year) %>%
    group_by(Region, SurveyName, Species, Common) %>%
    group_modify(~{
      df <- .x
      n_years <- nrow(df)
      abs_vec <- df$Absence_Presence
      percent_present <- sum(abs_vec == 1, na.rm = TRUE) / n_years

      # Indices for first/last half
      half_n <- floor(n_years / 2)
      first_half_idx <- seq_len(half_n)
      last_half_idx <- seq(n_years - half_n + 1, n_years)

      abs_first_half <- if(length(first_half_idx) > 0) sum(abs_vec[first_half_idx] == 1, na.rm = TRUE) else NA_real_
      abs_last_half <- if(length(last_half_idx) > 0) sum(abs_vec[last_half_idx] == 1, na.rm = TRUE) else NA_real_
      percent_first_half <- if(length(first_half_idx) > 0) abs_first_half / length(first_half_idx) else NA_real_
      percent_last_half <- if(length(last_half_idx) > 0) abs_last_half / length(last_half_idx) else NA_real_

      # Indices for last 5 years
      last5_n <- min(5, n_years)
      last5_idx <- seq(n_years - last5_n + 1, n_years)
      abs_last5 <- if(length(last5_idx) > 0) sum(abs_vec[last5_idx] == 1, na.rm = TRUE) else NA_real_

      trend_category <- case_when(
        percent_present >= 0.85 & abs_last5 >= 4 ~ "Persistently Present",
        percent_present > 0.5 & abs_last5 >= 4 &
          percent_last_half >= 0.75 &
          abs_first_half <= abs_last_half ~ "Established",
        percent_present <= 0.5 & abs_last5 <= 1 &
          percent_last_half <= 0.35 &
          abs_first_half >= abs_last_half ~ "Disappeared",
        abs_last5 >= 4 & percent_first_half <= 0.60 ~ "Potentially Emerging",
        
        abs_last5 <= 1 & percent_first_half >= 0.40 ~ "Potentially Disappearing",
        
        percent_present >= 0.5 ~ "Sporadic - Primarily Present",
        percent_present < 0.5 ~ "Sporadic - Primarily Absent",
        TRUE ~ NA_character_
      )
      df$TrendCategory <- trend_category
      df
    }) %>%
    ungroup()
}

# Usage:
data_full_trends1 <- add_trend_category1(data) %>% 
  mutate( Name = paste(Common, SurveyName, sep = "_"))

data_summary1 <- add_trend_category1(data) %>%
  select(Region, SurveyName, Species, Common, TrendCategory) %>%
  distinct()
```

The following table provides the number of species that fall into each category, using this version of the metrics.
```{r summary table1, eval=FALSE}

library(knitr)

trendsummary1 <- data_summary1 %>%
  group_by(TrendCategory) %>%
  summarize(n = n())

kable(trendsummary1)

```
The following visualizations capture the trends of the species that fall into each category, using this version of metrics.
```{r viz of trends1, eval=FALSE}

#Persistently Present
trend_pres <- data_full_trends1 %>% 
  filter(TrendCategory == "Persistently Present")

ggplot(trend_pres, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Persistently Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Established
trend_estab <- data_full_trends1 %>% 
  filter(TrendCategory == "Established")

p6 <- ggplot(trend_estab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Established") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p6)


#Disappeared
trend_disapp <- data_full_trends1 %>% 
  filter(TrendCategory == "Disappeared")

ggplot(trend_disapp, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Disappeared") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Potentially Emerging
trend_emerging <- data_full_trends1 %>% 
  filter(TrendCategory == "Potentially Emerging")

ggplot(trend_emerging, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Emerging") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Potentially Disappearing
trend_potdis <- data_full_trends1 %>% 
  filter(TrendCategory == "Potentially Disappearing")

ggplot(trend_potdis, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Disappearing") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Sporadic - Primarily Present
trend_spopre <- data_full_trends1 %>% 
  filter(TrendCategory == "Sporadic - Primarily Present")

p5 <- ggplot(trend_spopre, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p5)


#Sporadic - Primarily Absent
trend_spoab <- data_full_trends1 %>% 
  filter(TrendCategory == "Sporadic - Primarily Absent")

p4 <- ggplot(trend_spoab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Absent") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p4)

```

### Alternate Version 2
This version categorizes species observation trends across years into one of the seven categories, based on the following metrics:

**Category Metrics**

- *Persistently Present*: Observed in >=88% of survey years
- *Established*: Observed in >50% of years, observed more in the second half of the survey years (compared to the first half of survey years), observed in >= 75% of the second half of survey years, and observed in at least four (presence >= 4) of the final five survey years
- *Potentially Emerging*: Observed in <= 45% of years in the first half of survey years and observed in at least four (presence >= 4) of the final five survey years
- *Potentially Disappearing*: Observed in >= 55% of years in the first half of survey years and observed in at most one (presence <= 1) of the final five survey years
- *Disappeared*: Observed in <=50% of years, observed more in the first half of the survey years (compared to the second half of survey years), observed in <= 35% of the second half of survey years, and observed in at most one (presence <= 1) of the final five survey years
- *Sporadic - Primarily Present*: Observed in >=50% of years
- *Sporadic - Primarily Absent*: Observed in <50% of years


Here, we make some small changes to the "Persistently Present" category (makes it more strict) and to the "Potentially Disappearing/Emerging" categories, making the rule about the first 50% of years more strict to highlight scenarios in which a shift is more dramatic.

```{r function add_trend_category2, eval=FALSE}

add_trend_category2 <- function(data) {
  data %>%
    arrange(Region, SurveyName, Species, Common, Year) %>%
    group_by(Region, SurveyName, Species, Common) %>%
    group_modify(~{
      df <- .x
      n_years <- nrow(df)
      abs_vec <- df$Absence_Presence
      percent_present <- sum(abs_vec == 1, na.rm = TRUE) / n_years

      # Indices for first/last half
      half_n <- floor(n_years / 2)
      first_half_idx <- seq_len(half_n)
      last_half_idx <- seq(n_years - half_n + 1, n_years)

      abs_first_half <- if(length(first_half_idx) > 0) sum(abs_vec[first_half_idx] == 1, na.rm = TRUE) else NA_real_
      abs_last_half <- if(length(last_half_idx) > 0) sum(abs_vec[last_half_idx] == 1, na.rm = TRUE) else NA_real_
      percent_first_half <- if(length(first_half_idx) > 0) abs_first_half / length(first_half_idx) else NA_real_
      percent_last_half <- if(length(last_half_idx) > 0) abs_last_half / length(last_half_idx) else NA_real_

      # Indices for last 5 years
      last5_n <- min(5, n_years)
      last5_idx <- seq(n_years - last5_n + 1, n_years)
      abs_last5 <- if(length(last5_idx) > 0) sum(abs_vec[last5_idx] == 1, na.rm = TRUE) else NA_real_

      trend_category <- case_when(
        percent_present >= 0.88 & abs_last5 >= 4 ~ "Persistently Present",
        percent_present > 0.5 & abs_last5 >= 4 &
          percent_last_half >= 0.75 &
          abs_first_half <= abs_last_half ~ "Established",
        percent_present <= 0.5 & abs_last5 <= 1 &
          percent_last_half <= 0.35 &
          abs_first_half >= abs_last_half ~ "Disappeared",
        abs_last5 >= 4 & percent_first_half <= 0.45 ~ "Potentially Emerging",
        abs_last5 <= 1 & percent_first_half >= 0.55 ~ "Potentially Disappearing",
        percent_present >= 0.5 ~ "Sporadic - Primarily Present",
        percent_present < 0.5 ~ "Sporadic - Primarily Absent",
        TRUE ~ NA_character_
      )
      df$TrendCategory <- trend_category
      df
    }) %>%
    ungroup()
}

# Usage:
data_full_trends2 <- add_trend_category2(data)  %>% 
  mutate( Name = paste(Common, SurveyName, sep = "_"))

data_summary2 <- add_trend_category2(data) %>%
  select(Region, SurveyName, Species, Common, TrendCategory) %>%
  distinct()
```

The following table provides the number of species that fall into each category, using this version of the metrics.
```{r summary table2, eval=FALSE}

library(knitr)

trendsummary2 <- data_summary2 %>%
  group_by(TrendCategory) %>%
  summarize(n = n())

kable(trendsummary2)

```

The following visualizations capture the trends of the species that fall into each category, using this version of metrics.
```{r viz of trends2, eval=FALSE}

#Persistently Present 
trend_pres <- data_full_trends2 %>% 
  filter(TrendCategory == "Persistently Present")

ggplot(trend_pres, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Persistently Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Established
trend_estab <- data_full_trends2 %>% 
  filter(TrendCategory == "Established")

p6 <- ggplot(trend_estab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Established") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p6)


#Disappeared 
trend_disapp <- data_full_trends2 %>% 
  filter(TrendCategory == "Disappeared")

ggplot(trend_disapp, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Disappeared") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Potentially Emerging 
trend_emerging <- data_full_trends2 %>% 
  filter(TrendCategory == "Potentially Emerging")

ggplot(trend_emerging, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Emerging") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Potentially Disappearing 
trend_potdis <- data_full_trends2 %>% 
  filter(TrendCategory == "Potentially Disappearing")

ggplot(trend_potdis, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Disappearing") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Sporadic - Primarily Present 
trend_spopre <- data_full_trends2 %>% 
  filter(TrendCategory == "Sporadic - Primarily Present")

p5 <- ggplot(trend_spopre, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p5)


#Sporadic - Primarily Absent 
trend_spoab <- data_full_trends2 %>% 
  filter(TrendCategory == "Sporadic - Primarily Absent")

p4 <- ggplot(trend_spoab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Absent") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p4)

```
### Alternative Version 3

This version categorizes species observation trends across years into one of the seven categories, based on the following metrics:

**Category Metrics**

- *Persistently Present*: Observed in >=85% of survey years
- *Established*: Observed in >50% of years, observed more in the second half of the survey years (compared to the first half of survey years), observed in >= 75% of the second half of survey years, and observed in at least four (presence >= 4) of the final five survey years
- *Potentially Emerging*: Observed in <= 50% of years in the first half of survey years and observed in at least three (presence >= 3) of the final five survey years
- *Potentially Disappearing*: Observed in >= 50% of years in the first half of survey years and observed in at most two (presence <= 2) of the final five survey years
- *Disappeared*: Observed in <=50% of years, observed more in the first half of the survey years (compared to the second half of survey years), observed in <= 35% of the second half of survey years, and observed in at most one (presence <= 1) of the final five survey years
- *Sporadic - Primarily Present*: Observed in >=50% of years
- *Sporadic - Primarily Absent*: Observed in <50% of years


Here, we loosen the requirement for "Potentially Disappearing/Emerging", in the attempt to identify a shift in a species being observed year sooner.


```{r function add_trend_category3, eval=FALSE}

add_trend_category3 <- function(data) {
  data %>%
    arrange(Region, SurveyName, Species, Common, Year) %>%
    group_by(Region, SurveyName, Species, Common) %>%
    group_modify(~{
      df <- .x
      n_years <- nrow(df)
      abs_vec <- df$Absence_Presence
      percent_present <- sum(abs_vec == 1, na.rm = TRUE) / n_years

      # Indices for first/last half
      half_n <- floor(n_years / 2)
      first_half_idx <- seq_len(half_n)
      last_half_idx <- seq(n_years - half_n + 1, n_years)

      abs_first_half <- if(length(first_half_idx) > 0) sum(abs_vec[first_half_idx] == 1, na.rm = TRUE) else NA_real_
      abs_last_half <- if(length(last_half_idx) > 0) sum(abs_vec[last_half_idx] == 1, na.rm = TRUE) else NA_real_
      percent_first_half <- if(length(first_half_idx) > 0) abs_first_half / length(first_half_idx) else NA_real_
      percent_last_half <- if(length(last_half_idx) > 0) abs_last_half / length(last_half_idx) else NA_real_

      # Indices for last 5 years
      last5_n <- min(5, n_years)
      last5_idx <- seq(n_years - last5_n + 1, n_years)
      abs_last5 <- if(length(last5_idx) > 0) sum(abs_vec[last5_idx] == 1, na.rm = TRUE) else NA_real_

      trend_category <- case_when(
        percent_present >= 0.85 & abs_last5 >= 4 ~ "Persistently Present",
        percent_present > 0.5 & abs_last5 >= 4 &
          percent_last_half >= 0.75 &
          abs_first_half <= abs_last_half ~ "Established",
        percent_present <= 0.5 & abs_last5 <= 1 &
          percent_last_half <= 0.35 &
          abs_first_half >= abs_last_half ~ "Disappeared",
        abs_last5 >= 3 & percent_first_half <= 0.50 ~ "Potentially Emerging",
        abs_last5 <= 2 & percent_first_half >= 0.50 ~ "Potentially Disappearing",
        percent_present >= 0.5 ~ "Sporadic - Primarily Present",
        percent_present < 0.5 ~ "Sporadic - Primarily Absent",
        TRUE ~ NA_character_
      )
      df$TrendCategory <- trend_category
      df
    }) %>%
    ungroup()
}

# Usage:
data_full_trends3 <- add_trend_category3(data)  %>% 
  mutate( Name = paste(Common, SurveyName, sep = "_"))

data_summary3 <- add_trend_category3(data) %>%
  select(Region, SurveyName, Species, Common, TrendCategory) %>%
  distinct()
```


The following table provides the number of species that fall into each category, using this version of the metrics.
```{r summary table3, eval=FALSE}

library(knitr)

trendsummary3 <- data_summary3 %>%
  group_by(TrendCategory) %>%
  summarize(n = n())

kable(trendsummary3)

```

The following visualizations capture the trends of the species that fall into each category, using this version of metrics.
```{r viz of trends3, eval=FALSE}

#Persistently Present 
trend_pres <- data_full_trends3 %>% 
  filter(TrendCategory == "Persistently Present")

ggplot(trend_pres, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Persistently Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Established
trend_estab <- data_full_trends3 %>% 
  filter(TrendCategory == "Established")

p6 <- ggplot(trend_estab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Established") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p6)


#Disappeared 
trend_disapp <- data_full_trends3 %>% 
  filter(TrendCategory == "Disappeared")

ggplot(trend_disapp, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Disappeared") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Potentially Emerging 
trend_emerging <- data_full_trends3 %>% 
  filter(TrendCategory == "Potentially Emerging")

ggplot(trend_emerging, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Emerging") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Potentially Disappearing 
trend_potdis <- data_full_trends3 %>% 
  filter(TrendCategory == "Potentially Disappearing")

ggplot(trend_potdis, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Disappearing") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))


#Sporadic - Primarily Present 
trend_spopre <- data_full_trends3 %>% 
  filter(TrendCategory == "Sporadic - Primarily Present")

p5 <- ggplot(trend_spopre, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p5)


#Sporadic - Primarily Absent 
trend_spoab <- data_full_trends3 %>% 
  filter(TrendCategory == "Sporadic - Primarily Absent")

p4 <- ggplot(trend_spoab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Absent") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(p4)

```

### Alternative Version 4

This version categorizes species observation trends across years into one of the seven categories, based on the following metrics:

**Category Metrics**

- *Persistently Present*: Observed in >=85% of survey years
- *Emerged*: Observed in >=50% of years, observed more in the second half of the survey years (compared to the first half of survey years), observed in >= 75% of the second half of survey years, and observed in at least nine (presence >= 9) of the final ten survey years
- *Potentially Emerging*: Observed in <= 50% of years in the first half of survey years and observed in at least four (presence >= 4) of the final five survey years, or has one switch from not being observed to being observed (referred to as a "colonizing event") and has zero switches from being observed to not being observed (referred to as a leaving event)
- *Potentially Disappearing*: Observed in >= 50% of years in the first half of survey years and observed in at most one (presence <= 1) of the final five survey years, or has one switch from being observed to not being observed (leaving event) and has zero switches from not being observed to being observed (colonizing event)
- *Disappeared*: Observed in <=50% of years, observed more in the first half of the survey years (compared to the second half of survey years), observed in <= 25% of the second half of survey years, and observed in at most one (presence <= 1) of the final ten survey years
- *Sporadic - Primarily Present*: Observed in >=50% of years
- *Sporadic - Primarily Absent*: Observed in <50% of years

In this version, we have added an additional rule to the "Potentially Emerging/Disappearing" categories that would prevent any species that only have one colonizing/leaving event from being categorized as being "sporadic".

```{r function add_trend_category4}

add_trend_category <- function(data) {
  data %>%
    arrange(Region, SurveyName, Species, Common, Year) %>%
    group_by(Region, SurveyName, Species, Common) %>%
    group_modify(~{
      df <- .x
      n_years <- nrow(df)
      abs_vec <- df$Absence_Presence
      percent_present <- sum(abs_vec == 1, na.rm = TRUE) / n_years

      # Indices for first/last half
      half_n <- floor(n_years / 2)
      first_half_idx <- seq_len(half_n)
      last_half_idx <- seq(n_years - half_n + 1, n_years)

      abs_first_half <- if(length(first_half_idx) > 0) sum(abs_vec[first_half_idx] == 1, na.rm = TRUE) else NA_real_
      abs_last_half <- if(length(last_half_idx) > 0) sum(abs_vec[last_half_idx] == 1, na.rm = TRUE) else NA_real_
      percent_first_half <- if(length(first_half_idx) > 0) abs_first_half / length(first_half_idx) else NA_real_
      percent_last_half <- if(length(last_half_idx) > 0) abs_last_half / length(last_half_idx) else NA_real_

      # Indices for last 5 years
      last5_n <- min(5, n_years)
      last5_idx <- seq(n_years - last5_n + 1, n_years)
      abs_last5 <- if(length(last5_idx) > 0) sum(abs_vec[last5_idx] == 1, na.rm = TRUE) else NA_real_
      
      # Indices for last 10 years
      last10_n <- min(10, n_years)
      last10_idx <- seq(n_years - last10_n + 1, n_years)
      abs_last10 <- if(length(last10_idx) > 0) sum(abs_vec[last10_idx] == 1, na.rm = TRUE) else NA_real_

      trend_category <- case_when(
        percent_present >= 0.85 & abs_last5 >= 4 ~ "Persistently Present",
        percent_present >= 0.5 & abs_last10 >= 9 &
          percent_last_half >= 0.75 &
          abs_first_half <= abs_last_half ~ "Emerged",
        percent_present <= 0.5 & abs_last10 <= 1 &
          percent_last_half <= 0.25 &
          abs_first_half >= abs_last_half ~ "Disappeared",
        abs_last5 >= 4 & percent_first_half <= 0.50 ~ "Potentially Emerging",
        any(df$col == 1 & df$ext == 0, na.rm = TRUE) ~ "Potentially Emerging",
        abs_last5 <= 1 & percent_first_half >= 0.50 ~ "Potentially Disappearing",
        any(df$col == 0 & df$ext == 1, na.rm = TRUE) ~ "Potentially Disappearing",
        percent_present >= 0.5 ~ "Sporadic - Primarily Present",
        percent_present < 0.5 ~ "Sporadic - Primarily Absent",
        TRUE ~ NA_character_
      )
      df$TrendCategory <- trend_category
      df
    }) %>%
    ungroup()
}

# Usage:
data_full_trends <- add_trend_category(data) %>%
  mutate(Name = paste(Common, SurveyName, sep = "_"))

data_summary <- add_trend_category(data) %>%
  select(Region, SurveyName, Species, Common, TrendCategory) %>%
  distinct()
```

```{r export data_full_trends}

data_trends_export <- data_summary %>% 
  select(Region, SurveyName, Species, Common, TrendCategory)

# write.csv(data_trends_export, here::here("data_processing_rcode","output","data_clean","SpeciesPersistenceIndicatorTrend.csv"))

```


The following table provides the number of species that fall into each category, using this version of the metrics.
```{r summary table4}

library(knitr)

trendsummary <- data_summary %>%
  group_by(TrendCategory) %>%
  summarize(n = n())

kable(trendsummary)

```
The following visualizations capture the trends of the species that fall into each category, using this version of metrics.
```{r viz of trends4}

#Persistently Present 
trend_pres <- data_full_trends4 %>% 
  filter(TrendCategory == "Persistently Present")

ggplot(trend_pres, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Persistently Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

#Established
trend_estab <- data_full_trends4 %>% 
  filter(TrendCategory == "Established")

p6 <- ggplot(trend_estab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Established") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p6)


#Disappeared 
trend_disapp <- data_full_trends4 %>% 
  filter(TrendCategory == "Disappeared")

p2 <- ggplot(trend_disapp, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Disappeared") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p2)

#Potentially Emerging 
trend_emerging <- data_full_trends4 %>% 
  filter(TrendCategory == "Potentially Emerging")

p3 <- ggplot(trend_emerging, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Emerging") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p3)

#Potentially Disappearing 
trend_potdis <- data_full_trends4 %>% 
  filter(TrendCategory == "Potentially Disappearing")

p7 <- ggplot(trend_potdis, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Disappearing") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p7)

#Sporadic - Primarily Present 
trend_spopre <- data_full_trends4 %>% 
  filter(TrendCategory == "Sporadic - Primarily Present")

p5 <- ggplot(trend_spopre, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p5)


#Sporadic - Primarily Absent 
trend_spoab <- data_full_trends4 %>% 
  filter(TrendCategory == "Sporadic - Primarily Absent")

p4 <- ggplot(trend_spoab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Absent") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p4)

```


### Problems

The following trends are still categorized as "Potentially emerging", despite having many consecutive years of presence. Does this align will with our definition of "Potentially emerging"? Or would it be better suited for "Established" by this point?
```{r ex2}
ex2 <- data_full_trends4 %>% 
  filter(TrendCategory == "Potentially Emerging") %>% 
  filter(Common == "Oblique smoothcockle" | Common == "Atlantic moonfish")

pex2 <- ggplot(ex2, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Emerging") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(pex2)
```
