---
title: "Species Persistence Trend Categorization"
author: "Claire Gonzales (NOAA Affiliate)"
date: "2025-05-22"
output:
  html_document:
    toc: yes
    toc_float: true
    theme: readable
    code_folding: hide
  word_document:
    toc: yes
  pdf_document:
    toc: yes
---

*Code chunks can be viewed by pressing the `SHOW` button on the right hand side of the document*

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)

library(here)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(readr)
library(tidyverse)
library(hrbrthemes)
library(viridis)
library(plotly)
library(heatmaply)
```

## Background

**Feedback on the usefulness of these analyses and visualizations would be greatly appreciated. Specifically, we would appreciate any comments on which set of definitions and parameters that you feel would produce an analysis that is the most useful to DisMAP end-users. Please feel free to contact Melissa and Claire at any time with questions or comments.**

This analysis was completed to supplement the measure of biomass across years in the new Species Persistence Indicator and categorize the biomass trends of a species in each Survey Region over time. We have developed seven categories to define biomass trends of species over time, based on how often that species is observed in a survey or not, and they are as follows:

```{r load data}
# Loading R Data product created in chunk 13 of `Species_Persistence_Brainstorm.Rmd`

data_full <- readRDS(here("data_processing_rcode", "code", "data_full.RData"))
data_ce <-readRDS(here("data_processing_rcode", "code", "data_ce.RData"))

data <- data_full %>% 
  left_join(data_ce, by = c("SurveyName", "Species", "Common"))
```

**Trend Categories**

- Persistently Present: Consistently observed in surveys across years;
- Established: Species previously wasn't observed in surveys and now is consistently observed in surveys;
- Potentially Emerging: Species previously wasn't consistently observed in surveys but is potentially shifting towards being consistently observed;
- Potentially Disappearing: Species was previously observed in surveys but is potentially shifting towards being consistently not observed;
- Disappeared: Species was previously observed in surveys but now is consistently not observed in surveys;
- Sporadic - Primarily Present: Species is observed in over half of surveys but observations are inconsistent; and
- Sporadic - Primarily Absent: Species is observed in less than half of surveys and observations are inconsistent.


The quantitative metrics used to define each category will greatly impact which trends fall into which category. In this document, we have provided five options for applying metrics to the trends, as well as mock visualizations of each option. *If possible, please review the following five options and provide any feedback you might have as to which set of metrics best captures the trend categories.*


## Trend Variations

As a note: these figures are mock-ups and outputs will be optimized and finalized by the DisMAP development team prior to the update.


### Current Version

This version categorizes species observation trends across years into one of the seven categories, based on the following metrics:

**Category Metrics**

- *Persistently Present*: Observed in >=85% of survey years
- *Emerged*: Observed in >=50% of years, observed more in the second half of the survey years (compared to the first half of survey years), observed in >= 75% of the second half of survey years, and observed in at least nine (presence >= 9) of the final ten survey years
- *Potentially Emerging*: Observed in <= 50% of years in the first half of survey years and observed in at least four (presence >= 4) of the final five survey years, or has one switch from not being observed to being observed (referred to as a "colonizing event") and has zero switches from being observed to not being observed (referred to as a leaving event)
- *Potentially Disappearing*: Observed in >= 50% of years in the first half of survey years and observed in at most one (presence <= 1) of the final five survey years, or has one switch from being observed to not being observed (leaving event) and has zero switches from not being observed to being observed (colonizing event)
- *Disappeared*: Observed in <=50% of years, observed more in the first half of the survey years (compared to the second half of survey years), observed in <= 25% of the second half of survey years, and observed in at most one (presence <= 1) of the final ten survey years
- *Sporadic - Primarily Present*: Observed in >=50% of years
- *Sporadic - Primarily Absent*: Observed in <50% of years

In this version, we have added an additional rule to the "Potentially Emerging/Disappearing" categories that would prevent any species that only have one colonizing/leaving event from being categorized as being "sporadic".

```{r function add_trend_category}

add_trend_category <- function(data) {
  data %>%
    arrange(Region, SurveyName, Species, Common, Year) %>%
    group_by(Region, SurveyName, Species, Common) %>%
    group_modify(~{
      df <- .x
      n_years <- nrow(df)
      abs_vec <- df$Absence_Presence
      percent_present <- sum(abs_vec == 1, na.rm = TRUE) / n_years

      # Indices for first/last half
      half_n <- floor(n_years / 2)
      first_half_idx <- seq_len(half_n)
      last_half_idx <- seq(n_years - half_n + 1, n_years)

      abs_first_half <- if(length(first_half_idx) > 0) sum(abs_vec[first_half_idx] == 1, na.rm = TRUE) else NA_real_
      abs_last_half <- if(length(last_half_idx) > 0) sum(abs_vec[last_half_idx] == 1, na.rm = TRUE) else NA_real_
      percent_first_half <- if(length(first_half_idx) > 0) abs_first_half / length(first_half_idx) else NA_real_
      percent_last_half <- if(length(last_half_idx) > 0) abs_last_half / length(last_half_idx) else NA_real_

      # Indices for last 5 years
      last5_n <- min(5, n_years)
      last5_idx <- seq(n_years - last5_n + 1, n_years)
      abs_last5 <- if(length(last5_idx) > 0) sum(abs_vec[last5_idx] == 1, na.rm = TRUE) else NA_real_
      
      # Indices for last 10 years
      last10_n <- min(10, n_years)
      last10_idx <- seq(n_years - last10_n + 1, n_years)
      abs_last10 <- if(length(last10_idx) > 0) sum(abs_vec[last10_idx] == 1, na.rm = TRUE) else NA_real_

      trend_category <- case_when(
        percent_present >= 0.85 & abs_last5 >= 4 ~ "Persistently Present",
        percent_present >= 0.5 & abs_last10 >= 9 &
          percent_last_half >= 0.75 &
          abs_first_half <= abs_last_half ~ "Emerged",
        percent_present <= 0.5 & abs_last10 <= 1 &
          percent_last_half <= 0.25 &
          abs_first_half >= abs_last_half ~ "Disappeared",
        abs_last5 >= 4 & percent_first_half <= 0.50 ~ "Potentially Emerging",
        any(df$col == 1 & df$ext == 0, na.rm = TRUE) ~ "Potentially Emerging",
        abs_last5 <= 1 & percent_first_half >= 0.50 ~ "Potentially Disappearing",
        any(df$col == 0 & df$ext == 1, na.rm = TRUE) ~ "Potentially Disappearing",
        percent_present >= 0.5 ~ "Sporadic - Primarily Present",
        percent_present < 0.5 ~ "Sporadic - Primarily Absent",
        TRUE ~ NA_character_
      )
      df$TrendCategory <- trend_category
      df
    }) %>%
    ungroup()
}

# Usage:
data_full_trends <- add_trend_category(data) %>%
  mutate(Name = paste(Common, SurveyName, sep = "_"))

data_summary <- add_trend_category(data) %>%
  select(Region, SurveyName, Species, Common, TrendCategory) %>%
  distinct()
```


```{r species flag function}

data <- data_full_trends

flag_spp <- function(data, survey){
  
  cat("taxonomy check for survey: ", survey, sep="\n")
  
  #select region (survey column)
  data_survey <- data %>% 
    dplyr::mutate(SurveyName = forcats::as_factor(SurveyName)) %>% 
    dplyr::filter(SurveyName == survey)
  
  
  #get grouped species names per year
  df <- data_survey %>%
    dplyr::select(Species, Year, Absence_Presence) %>%
    dplyr::group_by(Species) %>%
    dplyr::distinct()

  
  #make species x year matrix
  years <- unique(df$Year)
  df2 <- data.frame(matrix(ncol = length(years)+1, nrow = length(df$Species)))
  x <- c('spp', unique(df$Year))
  colnames(df2) <- x
  df2$spp <- df$Species
  
  #fill up matrix with FALSE/TRUE depending on species presence/absence
  n <- 2
  for (y in years) {
    df2[, n] <- sapply(df2$spp, function(spp_name) {
      any(df$Species == spp_name & df$Year == y & df$Absence_Presence == 1)
      })
    n <- n + 1
    }
  
  #summarize
  df2 <- df2 %>%
    dplyr::group_by(spp) %>%
    dplyr::summarize_all(any)
  
  #create new dataframe
  df3 <- data.frame(matrix(ncol = 3, nrow = length(df2$spp)))
  colnames(df3) <- c('spp', 'rlmax', 'PresToAbs')
  
  #fill up the dataframe
  for (n in 1:length(df2$spp)){
    
    #Compute the lengths and values of runs of equal values in a vector
    r <- rle(df2[n,])
    
    sp <- c(df2[n,1])
    
    rlmax <- max(r$lengths)
    
    df3[n,1] <- sp
    df3[n,2] <- rlmax #maximum run length
    df3[n,3] <- length(r$values) #total nb of runs
    
  }
  
  #get species with maximum run length lower than 95% of the years (56)
  #and that occurred in less than 4 runs
  x <- round(0.95*length(years))
  df3 <- df3[df3$rlmax < x,]
  df3 <- df3[df3$PresToAbs < 4,]
  
  testdf <- data.frame(spp = df3$spp)
  
  if (dim(testdf)[1] > 0) {
    
    #write txt of flagged spp in region
    # sink(here::here("outputs", "Flags", "taxonomic_flagging", paste0(region, "_flagspp.txt")))
    # cat(testdf$spp, sep = " ; ")
    # sink()
    
    #write stats of species flagged
    # data_out <- data.frame("name" = c("Total number of species", "Percentage of species flagged"),
    #                    "nb" = c(length(df2$spp), round(100*(length(testdf$spp) /  length(df2$spp)), 1)))
    # write.csv(data_out, file = here::here("data_processing_rcode", "output", paste0(survey, "_stats.csv")), row.names = FALSE)
    
    #write df of species flagged
    survey_clean <- gsub("[/\\]", "_", survey)  # Replace slashes/backslashes with underscore
    write.csv(df3, file = here::here("data_processing_rcode", "output", "flags", paste0(survey_clean, "_flags.csv")), row.names = FALSE)
    
    #create absence dataframe for plotting
    allyears <- min(years):max(years)
    abs <- data.frame("accepted_name" = rep(df3$spp, each = length(allyears)),
                      "year" = rep(allyears, length(df3$spp)))
    
    #get presence dataframe for plotting
    pres <- subset(data_survey, Species %in% testdf$spp) %>%
      dplyr::select(Species, Year)
    
    #make summary scatterplot for region
    # p <- ggplot2::ggplot() +
    #   #absences
    #   ggplot2::geom_point(data = abs, ggplot2::aes(x = year, y = accepted_name, color = "black"), alpha = 0.2) +
    #   #presences
    #   ggplot2::geom_point(data = pres, ggplot2::aes(x = as.numeric(year), y = accepted_name, fill = "black")) +
    #   ggplot2::ggtitle(paste0("Survey: ", SurveyName)) +
    #   ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5),
    #                  axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5, hjust=1, size = 9),
    #                  text = element_text(size = 20),
    #                  legend.position = "bottom") +
    #   ggplot2::scale_fill_manual(values=c('black'), labels = c("presence"), name = "") +
    #   ggplot2::scale_colour_manual(values=c('black'), labels = c("absence"), name = "") +
    #   ggplot2::scale_x_continuous(breaks = allyears)
    
    #ggplot2::ggsave(p, filename = here::here("outputs", "Flags", "taxonomic_flagging", paste0(region, "_taxonomic_flagging.png")))
    
    # png(here::here("outputs", "Flags", "taxonomic_flagging", 
    #                paste0(region, "_taxonomic_flagging.png")),
    #     width = 16*200, height = 10*200, res = 200)
    # print(p)
    # dev.off()
    
  }else{
    
    print("----- No species flagged for this region")
  }
  
}

```

```{r flag compilation}

survey_list <- unique(data_full_trends$SurveyName)

for (i in survey_list) {
  flag_spp(data, survey = i)
}


#bringing csv files back into combine them into one df
folder_path <- here::here("data_processing_rcode", "output", "flags")

files <- list.files(path = folder_path, pattern = "\\.csv$", full.names = FALSE)




```

```{r export data_full_trends}

data_trends_export <- data_summary %>% 
  select(Region, SurveyName, Species, Common, TrendCategory)

# write.csv(data_trends_export, here::here("data_processing_rcode","output","data_clean","SpeciesPersistenceIndicatorTrend.csv"))

```


The following table provides the number of species that fall into each category, using this version of the metrics.
```{r summary table}

library(knitr)

trendsummary <- data_summary %>%
  group_by(TrendCategory) %>%
  summarize(n = n())

kable(trendsummary)

```
The following visualizations capture the trends of the species that fall into each category, using this version of metrics.
```{r viz of trends}

#regional review (temp)
trend_NESpring <- data_full_trends %>% 
  filter(SurveyName == "NEFSC Spring Bottom Trawl")

ggplot(trend_NESpring, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("NEFSC Spring Bottom Trawl") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))


#Persistently Present 
trend_pres <- data_full_trends %>% 
  filter(TrendCategory == "Persistently Present")

ggplot(trend_pres, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Persistently Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

#Established
trend_estab <- data_full_trends %>% 
  filter(TrendCategory == "Established")

p6 <- ggplot(trend_estab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Established") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p6)


#Disappeared 
trend_disapp <- data_full_trends %>% 
  filter(TrendCategory == "Disappeared")

p2 <- ggplot(trend_disapp, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Disappeared") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p2)

#Potentially Emerging 
trend_emerging <- data_full_trends %>% 
  filter(TrendCategory == "Potentially Emerging")

p3 <- ggplot(trend_emerging, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Emerging") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p3)

#Potentially Disappearing 
trend_potdis <- data_full_trends %>% 
  filter(TrendCategory == "Potentially Disappearing")

p7 <- ggplot(trend_potdis, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Disappearing") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p7)

#Sporadic - Primarily Present 
trend_spopre <- data_full_trends %>% 
  filter(TrendCategory == "Sporadic - Primarily Present")

p5 <- ggplot(trend_spopre, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Present") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p5)


#Sporadic - Primarily Absent 
trend_spoab <- data_full_trends %>% 
  filter(TrendCategory == "Sporadic - Primarily Absent")

p4 <- ggplot(trend_spoab, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Sporadic - Primarily Absent") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 15))

ggplotly(p4)

```


### Problems

The following trends are still categorized as "Potentially emerging", despite having many consecutive years of presence. Does this align will with our definition of "Potentially emerging"? Or would it be better suited for "Established" by this point?
```{r ex2}
ex2 <- data_full_trends4 %>% 
  filter(TrendCategory == "Potentially Emerging") %>% 
  filter(Common == "Oblique smoothcockle" | Common == "Atlantic moonfish")

pex2 <- ggplot(ex2, aes(Year, Name)) +
  geom_tile(aes(fill= Absence_Presence)) +
  ggtitle("Potentially Emerging") +
  theme_minimal() +
  scale_fill_viridis(discrete=TRUE, option="viridis") +
  scale_y_discrete(label = function(x) stringr::str_trunc(x, 12))

ggplotly(pex2)
```
